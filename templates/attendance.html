{% extends "base.html" %}

{% block title %}Attendance Records - Smart Attendance System{% endblock %}

{% block content %}
<div class="row fade-in-up">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-gradient-primary">
                <i class="fas fa-list me-2 icon-gradient-primary"></i>Attendance Records
            </h1>
            <div class="btn-group" role="group">
                <a href="{{ url_for('mark_attendance') }}" class="btn btn-gradient-success hover-lift-sm">
                    <i class="fas fa-user-check me-1"></i>Mark Attendance
                </a>
                <button class="btn btn-gradient-info hover-lift-sm" onclick="exportData('csv')">
                    <i class="fas fa-file-csv me-1"></i>Export CSV
                </button>
                <button class="btn btn-gradient-primary hover-lift-sm" onclick="exportData('excel')">
                    <i class="fas fa-file-excel me-1"></i>Export Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Filters -->
<div class="row mb-4 fade-in-up stagger-1">
    <div class="col-12">
        <div class="card-glass hover-lift-sm">
            <div class="card-header bg-dark-glass">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-gradient-primary">
                        <i class="fas fa-filter me-2 icon-gradient-primary"></i>Advanced Filters
                    </h5>
                    <button type="button" class="btn btn-glass btn-sm" id="toggleFilters">
                        <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" id="filterContent">
                <form method="GET" class="row g-3" id="filterForm">
                    <!-- Date Range Filters -->
                    <div class="col-md-3">
                        <div class="form-floating-glass">
                            <input type="date" class="form-control form-control-glass" id="date" name="date" 
                                   value="{{ current_date }}" placeholder="Select Date">
                            <label for="date">
                                <i class="fas fa-calendar me-1"></i>Date
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating-glass">
                            <input type="date" class="form-control form-control-glass" id="date_from" name="date_from" 
                                   value="{{ date_from or '' }}" placeholder="From Date">
                            <label for="date_from">
                                <i class="fas fa-calendar-alt me-1"></i>From Date
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating-glass">
                            <input type="date" class="form-control form-control-glass" id="date_to" name="date_to" 
                                   value="{{ date_to or '' }}" placeholder="To Date">
                            <label for="date_to">
                                <i class="fas fa-calendar-check me-1"></i>To Date
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating-glass">
                            <select class="form-select form-control-glass" id="status_filter" name="status_filter">
                                <option value="">All Status</option>
                                <option value="Present" {{ 'selected' if status_filter == 'Present' else '' }}>Present</option>
                                <option value="Absent" {{ 'selected' if status_filter == 'Absent' else '' }}>Absent</option>
                                <option value="Late" {{ 'selected' if status_filter == 'Late' else '' }}>Late</option>
                                <option value="Excused" {{ 'selected' if status_filter == 'Excused' else '' }}>Excused</option>
                            </select>
                            <label for="status_filter">
                                <i class="fas fa-user-check me-1"></i>Status
                            </label>
                        </div>
                    </div>
                    
                    <!-- Academic Filters -->
                    <div class="col-md-2">
                        <div class="form-floating-glass">
                            <select class="form-select form-control-glass" id="department" name="department">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                    <option value="{{ dept }}" {{ 'selected' if dept == current_department else '' }}>
                                        {{ dept }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="department">
                                <i class="fas fa-building me-1"></i>Department
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating-glass">
                            <select class="form-select form-control-glass" id="course" name="course">
                                <option value="">All Courses</option>
                                {% for course in courses %}
                                    <option value="{{ course }}" {{ 'selected' if course == current_course else '' }}>
                                        {{ course }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="course">
                                <i class="fas fa-graduation-cap me-1"></i>Course
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating-glass">
                            <select class="form-select form-control-glass" id="year" name="year">
                                <option value="">All Years</option>
                                {% for yr in years %}
                                    <option value="{{ yr }}" {{ 'selected' if yr == current_year else '' }}>
                                        {{ yr }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="year">
                                <i class="fas fa-calendar-alt me-1"></i>Year
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating-glass">
                            <select class="form-select form-control-glass" id="section" name="section">
                                <option value="">All Sections</option>
                                {% for sec in sections %}
                                    <option value="{{ sec }}" {{ 'selected' if sec == current_section else '' }}>
                                        {{ sec }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="section">
                                <i class="fas fa-users me-1"></i>Section
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating-glass">
                            <select class="form-select form-control-glass" id="subject" name="subject">
                                <option value="">All Subjects</option>
                                {% for subj in subjects %}
                                    <option value="{{ subj }}" {{ 'selected' if subj == current_subject else '' }}>
                                        {{ subj }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="subject">
                                <i class="fas fa-book me-1"></i>Subject
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-gradient-primary hover-lift-sm" id="applyFilters">
                                <i class="fas fa-search me-1"></i>Apply
                            </button>
                            <button type="button" class="btn btn-glass hover-lift-sm" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Quick Filter Buttons -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                            <span class="text-muted small">Quick Filters:</span>
                            <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="setQuickFilter('today')">
                                <i class="fas fa-calendar-day me-1"></i>Today
                            </button>
                            <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="setQuickFilter('yesterday')">
                                <i class="fas fa-calendar-minus me-1"></i>Yesterday
                            </button>
                            <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="setQuickFilter('week')">
                                <i class="fas fa-calendar-week me-1"></i>This Week
                            </button>
                            <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="setQuickFilter('month')">
                                <i class="fas fa-calendar me-1"></i>This Month
                            </button>
                            <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="setQuickFilter('present')">
                                <i class="fas fa-check-circle me-1 text-success"></i>Present Only
                            </button>
                            <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="setQuickFilter('absent')">
                                <i class="fas fa-times-circle me-1 text-danger"></i>Absent Only
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Attendance Records -->
<div class="row fade-in-up stagger-2">
    <div class="col-12">
        <div class="card-glass hover-lift-sm">
            <div class="card-header bg-dark-glass">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 text-gradient-primary me-3">
                            <i class="fas fa-table me-2 icon-gradient-primary"></i>Attendance Records
                            {% if current_date %}
                                <span class="text-muted">- {{ current_date }}</span>
                            {% endif %}
                        </h5>
                        <div class="badge badge-glass">
                            <i class="fas fa-database me-1"></i>
                            <span id="recordCount">{{ records|length }}</span> records
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                        <!-- Search Input -->
                        <div class="input-group" style="width: 280px;">
                            <input type="text" class="form-control form-control-glass" id="searchInput" 
                                   placeholder="Search records..." autocomplete="off">
                            <span class="input-group-text glass">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <!-- View Toggle -->
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-glass btn-sm active" id="tableView" onclick="toggleView('table')">
                                <i class="fas fa-table"></i>
                            </button>
                            <button type="button" class="btn btn-glass btn-sm" id="cardView" onclick="toggleView('card')">
                                <i class="fas fa-th-large"></i>
                            </button>
                        </div>
                        <!-- Refresh Button -->
                        <button type="button" class="btn btn-glass btn-sm hover-scale-sm" onclick="refreshData()" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if records %}
                    <!-- Loading Overlay -->
                    <div id="loadingOverlay" class="d-none position-absolute w-100 h-100 d-flex align-items-center justify-content-center" 
                         style="background: rgba(255,255,255,0.8); z-index: 10;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="text-muted">Loading records...</div>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div id="tableViewContainer" class="table-responsive">
                        <table class="table table-glass mb-0" id="attendanceTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="student_id">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Student ID
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="name">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Name
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="department">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Department
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="course">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Course
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="year">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Year
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="section">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Section
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="subject">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Subject
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="date">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Date
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="time_in">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Time In
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="sortable" data-column="status">
                                        <div class="d-flex align-items-center justify-content-between">
                                            Status
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th>Marked By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                {% for record in records %}
                                <tr class="table-row fade-in-up stagger-{{ loop.index % 6 + 1 }}" data-record-id="{{ record.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="icon-container icon-container-glass me-2" style="width: 2rem; height: 2rem;">
                                                <i class="fas fa-id-card text-primary"></i>
                                            </div>
                                            <strong class="text-primary">{{ record.student.student_id if record.student else 'N/A' }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                {% if record.student and record.student.photo_path %}
                                                    <img src="{{ url_for('static', filename='uploads/' + record.student.photo_path) }}" 
                                                         class="rounded-circle" width="32" height="32" alt="Student Photo">
                                                {% else %}
                                                    <div class="icon-container icon-container-glass" style="width: 2rem; height: 2rem;">
                                                        <i class="fas fa-user"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ record.student.name if record.student else 'N/A' }}</div>
                                                {% if record.student and record.student.email %}
                                                    <small class="text-muted">{{ record.student.email }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if record.student and record.student.department %}
                                            <span class="badge badge-gradient-primary">
                                                <i class="fas fa-building me-1"></i>{{ record.student.department }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.student and record.student.course %}
                                            <span class="badge badge-gradient-info">
                                                <i class="fas fa-graduation-cap me-1"></i>{{ record.student.course }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-glass">{{ record.student.year if record.student else 'N/A' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-glass">{{ record.student.section if record.student else 'N/A' }}</span>
                                    </td>
                                    <td>
                                        {% if record.subject %}
                                            <span class="badge badge-gradient-secondary">
                                                <i class="fas fa-book me-1"></i>{{ record.subject }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-calendar me-2 text-muted"></i>
                                            <span>{{ record.date.strftime('%Y-%m-%d') if record.date else 'N/A' }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if record.time_in %}
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-clock me-2"></i>
                                                <span>{{ record.time_in.strftime('%H:%M:%S') }}</span>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm status-select glass" 
                                                data-record-id="{{ record.id }}" 
                                                onchange="updateStatus(this)">
                                            <option value="Present" {{ 'selected' if record.status == 'Present' else '' }}>Present</option>
                                            <option value="Absent" {{ 'selected' if record.status == 'Absent' else '' }}>Absent</option>
                                            <option value="Late" {{ 'selected' if record.status == 'Late' else '' }}>Late</option>
                                            <option value="Excused" {{ 'selected' if record.status == 'Excused' else '' }}>Excused</option>
                                        </select>
                                    </td>
                                    <td>
                                        <span class="badge {{ 'badge-gradient-primary' if record.marked_by == 'System' else 'badge-glass' }}">
                                            <i class="fas fa-{{ 'robot' if record.marked_by == 'System' else 'user' }} me-1"></i>
                                            {{ record.marked_by or 'System' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-glass hover-scale-sm" 
                                                    onclick="viewRecord({{ record.id }})" 
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not record.time_out %}
                                                <button type="button" class="btn btn-glass hover-scale-sm text-warning" 
                                                        onclick="markTimeOut({{ record.id }})" 
                                                        title="Mark Time Out">
                                                    <i class="fas fa-sign-out-alt"></i>
                                                </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-glass hover-scale-sm text-danger" 
                                                    onclick="deleteRecord({{ record.id }})" 
                                                    title="Delete Record">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Card View (Hidden by default) -->
                    <div id="cardViewContainer" class="d-none p-3">
                        <div class="row" id="attendanceCards">
                            {% for record in records %}
                            <div class="col-md-6 col-lg-4 mb-3 attendance-card" data-record-id="{{ record.id }}">
                                <div class="card-glass hover-lift-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            {% if record.student and record.student.photo_path %}
                                                <img src="{{ url_for('static', filename='uploads/' + record.student.photo_path) }}" 
                                                     class="rounded-circle me-3" width="48" height="48" alt="Student Photo">
                                            {% else %}
                                                <div class="icon-container icon-container-glass me-3">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-1">{{ record.student.name if record.student else 'N/A' }}</h6>
                                                <small class="text-muted">{{ record.student.student_id if record.student else 'N/A' }}</small>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <small class="text-muted d-block">Department</small>
                                                <span class="badge badge-gradient-primary">{{ record.student.department if record.student else 'N/A' }}</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">Course</small>
                                                <span class="badge badge-gradient-info">{{ record.student.course if record.student else 'N/A' }}</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">Date</small>
                                                <span>{{ record.date.strftime('%Y-%m-%d') if record.date else 'N/A' }}</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">Time In</small>
                                                <span class="text-success">{{ record.time_in.strftime('%H:%M:%S') if record.time_in else 'N/A' }}</span>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <select class="form-select form-select-sm status-select glass" 
                                                    data-record-id="{{ record.id }}" 
                                                    onchange="updateStatus(this)" style="width: auto;">
                                                <option value="Present" {{ 'selected' if record.status == 'Present' else '' }}>Present</option>
                                                <option value="Absent" {{ 'selected' if record.status == 'Absent' else '' }}>Absent</option>
                                                <option value="Late" {{ 'selected' if record.status == 'Late' else '' }}>Late</option>
                                                <option value="Excused" {{ 'selected' if record.status == 'Excused' else '' }}>Excused</option>
                                            </select>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-glass hover-scale-sm" onclick="viewRecord({{ record.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-glass hover-scale-sm text-danger" onclick="deleteRecord({{ record.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Enhanced Pagination -->
                    <div class="card-footer bg-dark-glass">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-3">Show:</span>
                                <select class="form-select form-select-sm glass me-3" id="recordsPerPage" onchange="changeRecordsPerPage()" style="width: auto;">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span class="text-muted">
                                    Showing <span id="showingFrom">1</span> to <span id="showingTo">{{ records|length }}</span> 
                                    of <span id="totalRecords">{{ records|length }}</span> records
                                </span>
                            </div>
                            <nav aria-label="Attendance records pagination">
                                <ul class="pagination pagination-glass mb-0" id="paginationControls">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item active">
                                        <a class="page-link" href="#">1</a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                {% else %}
                    <!-- Enhanced Empty State -->
                    <div class="text-center py-5 empty-state-container">
                        <div class="empty-state-icon position-relative d-inline-block mb-4">
                            <i class="fas fa-calendar-times fa-4x text-gradient-primary"></i>
                            <div class="empty-state-particles">
                                <div class="particle particle-1"></div>
                                <div class="particle particle-2"></div>
                                <div class="particle particle-3"></div>
                            </div>
                        </div>
                        <h4 class="text-gradient-primary mb-3">No Attendance Records Found</h4>
                        <p class="text-muted mb-4 lead">
                            {% if current_date or current_department or current_year %}
                                Try adjusting your filters or 
                                <a href="{{ url_for('attendance') }}" class="text-decoration-none text-gradient-primary">clear all filters</a>
                            {% else %}
                                Start marking attendance to see records here
                            {% endif %}
                        </p>
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <a href="{{ url_for('mark_attendance') }}" class="btn btn-gradient-primary btn-lg hover-lift">
                                <i class="fas fa-camera me-2"></i>Mark Attendance
                            </a>
                            <button type="button" class="btn btn-glass btn-lg hover-lift" onclick="clearFilters()">
                                <i class="fas fa-filter me-2"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Summary Statistics -->
<div class="row fade-in-up stagger-3">
    <div class="col-md-3 mb-3">
        <div class="card-glass hover-lift-sm">
            <div class="card-body text-center">
                <div class="icon-container icon-container-gradient-success mx-auto mb-3">
                    <i class="fas fa-user-check"></i>
                </div>
                <h3 class="text-gradient-success mb-2 counter-animate" data-target="{{ records|selectattr('status', 'equalto', 'Present')|list|length }}">0</h3>
                <p class="mb-0 text-muted">Present</p>
                <div class="progress progress-glass mt-2" style="height: 4px;">
                    <div class="progress-bar progress-bar-gradient-success" role="progressbar" 
                         style="width: {{ (records|selectattr('status', 'equalto', 'Present')|list|length / records|length * 100) if records|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card-glass hover-lift-sm">
            <div class="card-body text-center">
                <div class="icon-container icon-container-gradient-warning mx-auto mb-3">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="text-gradient-warning mb-2 counter-animate" data-target="{{ records|selectattr('status', 'equalto', 'Late')|list|length }}">0</h3>
                <p class="mb-0 text-muted">Late</p>
                <div class="progress progress-glass mt-2" style="height: 4px;">
                    <div class="progress-bar progress-bar-gradient-warning" role="progressbar" 
                         style="width: {{ (records|selectattr('status', 'equalto', 'Late')|list|length / records|length * 100) if records|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card-glass hover-lift-sm">
            <div class="card-body text-center">
                <div class="icon-container icon-container-gradient-danger mx-auto mb-3">
                    <i class="fas fa-user-times"></i>
                </div>
                <h3 class="text-gradient-danger mb-2 counter-animate" data-target="{{ records|selectattr('status', 'equalto', 'Absent')|list|length }}">0</h3>
                <p class="mb-0 text-muted">Absent</p>
                <div class="progress progress-glass mt-2" style="height: 4px;">
                    <div class="progress-bar progress-bar-gradient-danger" role="progressbar" 
                         style="width: {{ (records|selectattr('status', 'equalto', 'Absent')|list|length / records|length * 100) if records|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card-glass hover-lift-sm">
            <div class="card-body text-center">
                <div class="icon-container icon-container-gradient-primary mx-auto mb-3">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="text-gradient-primary mb-2 counter-animate" data-target="{{ records|length }}">0</h3>
                <p class="mb-0 text-muted">Total Records</p>
                <div class="progress progress-glass mt-2" style="height: 4px;">
                    <div class="progress-bar progress-bar-gradient-primary" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Record Details Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-content-glass">
            <div class="modal-header modal-header-glass">
                <h5 class="modal-title text-gradient-primary">
                    <i class="fas fa-info-circle me-2"></i>Attendance Record Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recordDetails">
                <!-- Record details will be loaded here -->
            </div>
            <div class="modal-footer bg-dark-glass">
                <button type="button" class="btn btn-glass hover-lift-sm" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Close
                </button>
                <button type="button" class="btn btn-gradient-primary hover-lift-sm" onclick="editRecord()">
                    <i class="fas fa-edit me-1"></i>Edit Record
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Export Progress Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content modal-content-glass">
            <div class="modal-header modal-header-glass">
                <h5 class="modal-title text-gradient-primary">
                    <i class="fas fa-download me-2"></i>Exporting Data
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p class="mb-3">Preparing your export file...</p>
                <div class="progress progress-glass">
                    <div class="progress-bar progress-bar-gradient-primary" role="progressbar" 
                         style="width: 0%" id="exportProgress"></div>
                </div>
                <small class="text-muted mt-2 d-block" id="exportStatus">Initializing...</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables for pagination and sorting
let currentPage = 1;
let recordsPerPage = 25;
let sortColumn = '';
let sortDirection = 'asc';
let allRecords = [];
let filteredRecords = [];

$(document).ready(function() {
    // Initialize the page
    initializePage();
    
    // Enhanced search functionality with debouncing
    let searchTimeout;
    $('#searchInput').on('input', function() {
        clearTimeout(searchTimeout);
        const value = $(this).val().toLowerCase();
        
        searchTimeout = setTimeout(() => {
            performSearch(value);
        }, 300);
    });
    
    // Filter toggle functionality
    $('#toggleFilters').on('click', function() {
        const content = $('#filterContent');
        const icon = $('#filterToggleIcon');
        
        if (content.is(':visible')) {
            content.slideUp(300);
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        } else {
            content.slideDown(300);
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }
    });
    
    // Enhanced form submission with loading state
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        showLoadingState();
        
        // Simulate API call delay for demonstration
        setTimeout(() => {
            this.submit();
        }, 500);
    });
    
    // Sortable headers
    $('.sortable').on('click', function() {
        const column = $(this).data('column');
        handleSort(column);
    });
    
    // Initialize status select styling
    initializeStatusSelects();
    
    // Initialize counter animations
    animateCounters();
    
    // Set today's date as default if no date is set
    if (!$('#date').val()) {
        $('#date').val(new Date().toISOString().split('T')[0]);
    }
    
    // Store all records for client-side operations
    storeRecords();
    
    // Initialize pagination
    initializePagination();
});

function initializePage() {
    // Add loading states to buttons
    $('.btn').on('click', function() {
        if (!$(this).hasClass('no-loading')) {
            const btn = $(this);
            const originalText = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Loading...');
            
            setTimeout(() => {
                btn.prop('disabled', false).html(originalText);
            }, 2000);
        }
    });
    
    // Initialize tooltips
    $('[title]').tooltip();
}

function performSearch(searchTerm) {
    const rows = $('#attendanceTable tbody tr, .attendance-card');
    let visibleCount = 0;
    
    if (searchTerm === '') {
        rows.show();
        visibleCount = rows.length;
    } else {
        rows.each(function() {
            const text = $(this).text().toLowerCase();
            if (text.indexOf(searchTerm) > -1) {
                $(this).show();
                visibleCount++;
            } else {
                $(this).hide();
            }
        });
    }
    
    // Update record count
    $('#recordCount').text(visibleCount);
    updatePaginationInfo(visibleCount);
}

function handleSort(column) {
    // Update sort direction
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc';
    }
    
    // Update sort icons
    $('.sort-icon').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
    const currentIcon = $(`.sortable[data-column="${column}"] .sort-icon`);
    currentIcon.removeClass('fa-sort').addClass(sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
    
    // Perform sort
    sortTable(column, sortDirection);
}

function sortTable(column, direction) {
    const tbody = $('#attendanceTableBody');
    const rows = tbody.find('tr').toArray();
    
    rows.sort((a, b) => {
        let aVal = $(a).find(`td:eq(${getColumnIndex(column)})`).text().trim();
        let bVal = $(b).find(`td:eq(${getColumnIndex(column)})`).text().trim();
        
        // Handle different data types
        if (column === 'date' || column === 'time_in') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
        } else if (column === 'year') {
            aVal = parseInt(aVal) || 0;
            bVal = parseInt(bVal) || 0;
        }
        
        if (direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    // Add animation to sorted rows
    tbody.empty();
    rows.forEach((row, index) => {
        $(row).css('animation-delay', `${index * 0.05}s`).addClass('fade-in-up');
        tbody.append(row);
    });
}

function getColumnIndex(column) {
    const columnMap = {
        'student_id': 0,
        'name': 1,
        'department': 2,
        'course': 3,
        'year': 4,
        'section': 5,
        'subject': 6,
        'date': 7,
        'time_in': 8,
        'status': 9
    };
    return columnMap[column] || 0;
}

function initializeStatusSelects() {
    $('.status-select').each(function() {
        const status = $(this).val();
        const element = this;
        
        // Store original status
        element.setAttribute('data-original-status', status);
        
        // Apply enhanced styling
        updateStatusSelectStyle(element, status);
    });
}

function updateStatusSelectStyle(element, status) {
    $(element).removeClass('status-present status-absent status-late status-excused');
    
    switch(status) {
        case 'Present':
            $(element).addClass('status-present');
            break;
        case 'Absent':
            $(element).addClass('status-absent');
            break;
        case 'Late':
            $(element).addClass('status-late');
            break;
        case 'Excused':
            $(element).addClass('status-excused');
            break;
    }
}

function animateCounters() {
    $('.counter-animate').each(function() {
        const target = parseInt($(this).data('target'));
        const element = this;
        let current = 0;
        const increment = target / 50;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            $(element).text(Math.floor(current));
        }, 30);
    });
}

function toggleView(viewType) {
    const tableView = $('#tableViewContainer');
    const cardView = $('#cardViewContainer');
    const tableBtn = $('#tableView');
    const cardBtn = $('#cardView');
    
    if (viewType === 'table') {
        tableView.removeClass('d-none');
        cardView.addClass('d-none');
        tableBtn.addClass('active');
        cardBtn.removeClass('active');
    } else {
        tableView.addClass('d-none');
        cardView.removeClass('d-none');
        cardBtn.addClass('active');
        tableBtn.removeClass('active');
    }
}

function refreshData() {
    const btn = $('#refreshBtn');
    const icon = btn.find('i');
    
    icon.addClass('fa-spin');
    showLoadingState();
    
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function showLoadingState() {
    $('#loadingOverlay').removeClass('d-none');
}

function hideLoadingState() {
    $('#loadingOverlay').addClass('d-none');
}

function clearFilters() {
    $('#filterForm')[0].reset();
    $('#date').val(new Date().toISOString().split('T')[0]);
    window.location.href = window.location.pathname;
}

function setQuickFilter(type) {
    const today = new Date();
    const dateInput = $('#date');
    const dateFromInput = $('#date_from');
    const dateToInput = $('#date_to');
    const statusInput = $('#status_filter');
    
    // Clear existing filters
    $('#filterForm')[0].reset();
    
    switch(type) {
        case 'today':
            dateInput.val(today.toISOString().split('T')[0]);
            break;
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            dateInput.val(yesterday.toISOString().split('T')[0]);
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            dateFromInput.val(weekStart.toISOString().split('T')[0]);
            dateToInput.val(today.toISOString().split('T')[0]);
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            dateFromInput.val(monthStart.toISOString().split('T')[0]);
            dateToInput.val(today.toISOString().split('T')[0]);
            break;
        case 'present':
            statusInput.val('Present');
            break;
        case 'absent':
            statusInput.val('Absent');
            break;
    }
    
    // Submit the form
    $('#filterForm').submit();
}

function exportData(format) {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
    
    // Simulate export progress
    let progress = 0;
    const progressBar = $('#exportProgress');
    const statusText = $('#exportStatus');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            
            // Simulate download
            setTimeout(() => {
                modal.hide();
                showToast('success', `${format.toUpperCase()} file exported successfully!`);
            }, 500);
        }
        
        progressBar.css('width', progress + '%');
        
        if (progress < 30) {
            statusText.text('Gathering records...');
        } else if (progress < 60) {
            statusText.text('Processing data...');
        } else if (progress < 90) {
            statusText.text('Generating file...');
        } else {
            statusText.text('Finalizing export...');
        }
    }, 200);
}

function storeRecords() {
    // Store records for client-side operations
    allRecords = [];
    $('#attendanceTable tbody tr').each(function() {
        const row = $(this);
        allRecords.push({
            id: row.data('record-id'),
            element: row
        });
    });
    filteredRecords = [...allRecords];
}

function initializePagination() {
    updatePaginationControls();
}

function changeRecordsPerPage() {
    recordsPerPage = parseInt($('#recordsPerPage').val());
    currentPage = 1;
    updatePaginationControls();
    showRecordsForPage(currentPage);
}

function updatePaginationControls() {
    const totalRecords = filteredRecords.length;
    const totalPages = Math.ceil(totalRecords / recordsPerPage);
    
    // Update pagination info
    updatePaginationInfo(totalRecords);
    
    // Generate pagination controls
    const pagination = $('#paginationControls');
    pagination.empty();
    
    // Previous button
    pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" tabindex="-1">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);
    
    // Page numbers
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `);
    }
    
    // Next button
    pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    updatePaginationControls();
    showRecordsForPage(page);
}

function showRecordsForPage(page) {
    const startIndex = (page - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    
    // Hide all rows
    $('#attendanceTable tbody tr').hide();
    
    // Show rows for current page
    for (let i = startIndex; i < endIndex && i < filteredRecords.length; i++) {
        filteredRecords[i].element.show();
    }
}

function updatePaginationInfo(totalRecords) {
    const startRecord = Math.min((currentPage - 1) * recordsPerPage + 1, totalRecords);
    const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
    
    $('#showingFrom').text(startRecord);
    $('#showingTo').text(endRecord);
    $('#totalRecords').text(totalRecords);
}

function showToast(type, message) {
    const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    const toast = $(`
        <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            <i class="fas ${iconClass} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(toast);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        toast.fadeOut(() => toast.remove());
    }, 5000);
}

function viewRecord(recordId) {
    // Enhanced record details view
    const row = $(`tr[data-record-id="${recordId}"]`);
    const studentName = row.find('td:eq(1)').text().trim();
    const studentId = row.find('td:eq(0)').text().trim();
    const department = row.find('td:eq(2)').text().trim();
    const course = row.find('td:eq(3)').text().trim();
    const date = row.find('td:eq(7)').text().trim();
    const timeIn = row.find('td:eq(8)').text().trim();
    const status = row.find('.status-select').val();
    
    let html = `
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4 text-center mb-3">
                    <div class="icon-container icon-container-gradient-primary mx-auto mb-3" style="width: 4rem; height: 4rem;">
                        <i class="fas fa-user fa-2x"></i>
                    </div>
                    <h5 class="text-gradient-primary">${studentName}</h5>
                    <p class="text-muted mb-0">${studentId}</p>
                </div>
                <div class="col-md-8">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="card-glass p-3">
                                <small class="text-muted d-block">Department</small>
                                <strong>${department}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card-glass p-3">
                                <small class="text-muted d-block">Course</small>
                                <strong>${course}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card-glass p-3">
                                <small class="text-muted d-block">Date</small>
                                <strong>${date}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card-glass p-3">
                                <small class="text-muted d-block">Time In</small>
                                <strong class="text-success">${timeIn}</strong>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card-glass p-3">
                                <small class="text-muted d-block">Current Status</small>
                                <span class="badge badge-gradient-${getStatusColor(status)} fs-6">${status}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <div class="row">
                <div class="col-12">
                    <h6 class="text-gradient-primary mb-3">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h6>
                    <div class="timeline-container">
                        <div class="timeline-line position-absolute"></div>
                        <div class="timeline-items">
                            <div class="timeline-item fade-in-up">
                                <div class="timeline-dot position-absolute">
                                    <div class="timeline-dot-inner bg-success-gradient">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="timeline-content p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>Attendance Marked</strong>
                                            <p class="mb-0 text-muted">Status: ${status}</p>
                                        </div>
                                        <small class="text-muted">${timeIn}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#recordDetails').html(html);
    $('#recordModal').modal('show');
}

function getStatusColor(status) {
    switch(status) {
        case 'Present': return 'success';
        case 'Late': return 'warning';
        case 'Absent': return 'danger';
        case 'Excused': return 'info';
        default: return 'secondary';
    }
}

function editRecord() {
    showToast('info', 'Edit functionality would be implemented here');
}

function markTimeOut(recordId) {
    if (confirm('Mark time out for this student?')) {
        $.ajax({
            url: `/mark_time_out/${recordId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload(); // Refresh to show updated time
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error marking time out');
            }
        });
    }
}

function updateStatus(selectElement) {
    const recordId = selectElement.getAttribute('data-record-id');
    const newStatus = selectElement.value;
    const originalStatus = selectElement.getAttribute('data-original-status') || selectElement.value;
    
    // Add loading state to select
    $(selectElement).prop('disabled', true);
    
    if (confirm(`Change attendance status to "${newStatus}"?`)) {
        $.ajax({
            url: '/update_attendance_status',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                record_id: recordId,
                status: newStatus
            }),
            success: function(response) {
                if (response.success) {
                    // Update the select element styling
                    updateStatusSelectStyle(selectElement, newStatus);
                    selectElement.setAttribute('data-original-status', newStatus);
                    
                    // Update all matching selects (table and card view)
                    $(`.status-select[data-record-id="${recordId}"]`).each(function() {
                        this.value = newStatus;
                        updateStatusSelectStyle(this, newStatus);
                        this.setAttribute('data-original-status', newStatus);
                    });
                    
                    // Show success message with animation
                    showToast('success', response.message || 'Status updated successfully!');
                    
                    // Update summary statistics
                    updateSummaryStats();
                    
                    // Add success animation to row
                    const row = $(`tr[data-record-id="${recordId}"]`);
                    row.addClass('table-success');
                    setTimeout(() => row.removeClass('table-success'), 2000);
                    
                } else {
                    // Revert to original status
                    selectElement.value = originalStatus;
                    updateStatusSelectStyle(selectElement, originalStatus);
                    showToast('error', 'Error: ' + (response.message || 'Failed to update status'));
                }
            },
            error: function(xhr, status, error) {
                // Revert to original status
                selectElement.value = originalStatus;
                updateStatusSelectStyle(selectElement, originalStatus);
                showToast('error', 'Network error: Unable to update status');
                console.error('Status update error:', error);
            },
            complete: function() {
                // Remove loading state
                $(selectElement).prop('disabled', false);
            }
        });
    } else {
        // Revert to original status if cancelled
        selectElement.value = originalStatus;
        $(selectElement).prop('disabled', false);
    }
}

function deleteRecord(recordId) {
    // Enhanced confirmation dialog
    const row = $(`tr[data-record-id="${recordId}"]`);
    const studentName = row.find('td:eq(1)').text().trim();
    
    if (confirm(`Are you sure you want to delete the attendance record for "${studentName}"?\n\nThis action cannot be undone.`)) {
        // Add loading state
        const deleteBtn = $(`button[onclick="deleteRecord(${recordId})"]`);
        const originalHtml = deleteBtn.html();
        deleteBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: `/delete_attendance/${recordId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showToast('success', response.message || 'Record deleted successfully!');
                    
                    // Animate removal from both table and card views
                    const tableRow = $(`tr[data-record-id="${recordId}"]`);
                    const card = $(`.attendance-card[data-record-id="${recordId}"]`);
                    
                    // Remove from table view
                    tableRow.addClass('table-danger');
                    setTimeout(() => {
                        tableRow.fadeOut(300, function() {
                            $(this).remove();
                            updateSummaryStats();
                            updateRecordCount();
                        });
                    }, 500);
                    
                    // Remove from card view
                    card.fadeOut(300, function() {
                        $(this).remove();
                    });
                    
                } else {
                    showToast('error', 'Error: ' + (response.message || 'Failed to delete record'));
                    deleteBtn.prop('disabled', false).html(originalHtml);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', 'Network error: Unable to delete record');
                deleteBtn.prop('disabled', false).html(originalHtml);
                console.error('Delete error:', error);
            }
        });
    }
}

function updateRecordCount() {
    const visibleRows = $('#attendanceTable tbody tr:visible').length;
    $('#recordCount').text(visibleRows);
}

function updateSummaryStats() {
    // Recalculate and update summary statistics
    const rows = $('#attendanceTable tbody tr:visible');
    let presentCount = 0, absentCount = 0, lateCount = 0, excusedCount = 0;
    
    rows.each(function() {
        const status = $(this).find('.status-select').val();
        if (status === 'Present') presentCount++;
        else if (status === 'Absent') absentCount++;
        else if (status === 'Late') lateCount++;
        else if (status === 'Excused') excusedCount++;
    });
    
    // Update summary cards with animation
    animateCounterUpdate($('.counter-animate').eq(0), presentCount);
    animateCounterUpdate($('.counter-animate').eq(1), lateCount);
    animateCounterUpdate($('.counter-animate').eq(2), absentCount);
    animateCounterUpdate($('.counter-animate').eq(3), rows.length);
    
    // Update progress bars
    const total = rows.length;
    if (total > 0) {
        $('.progress-bar-gradient-success').css('width', (presentCount / total * 100) + '%');
        $('.progress-bar-gradient-warning').css('width', (lateCount / total * 100) + '%');
        $('.progress-bar-gradient-danger').css('width', (absentCount / total * 100) + '%');
    }
}

function animateCounterUpdate(element, newValue) {
    const currentValue = parseInt(element.text()) || 0;
    const increment = (newValue - currentValue) / 20;
    let current = currentValue;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= newValue) || (increment < 0 && current <= newValue)) {
            current = newValue;
            clearInterval(timer);
        }
        element.text(Math.floor(current));
    }, 50);
}
</script>
{% endblock %}