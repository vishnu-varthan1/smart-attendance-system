{% extends "base_clean.html" %}

{% block title %}Mark Attendance - Smart Attendance System{% endblock %}

{% block content %}
<div class="container container-sm">
    <!-- Creative Page Header -->
    <div class="page-header-creative">
        <div class="page-header-icon">
            <i class="fas fa-camera"></i>
        </div>
        <h1 class="page-title">Mark <span class="page-title-blue">Attendance</span></h1>
        <p class="page-subtitle">Use AI face recognition or manual entry to mark attendance</p>
    </div>
    
    <!-- Camera Section -->
    <div class="card slide-up">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-video text-primary" style="margin-right: 8px;"></i>
                Face Recognition
            </h3>
            <span class="badge" id="camera-status">
                <i class="fas fa-circle" style="font-size: 8px;"></i> Offline
            </span>
        </div>
        <div class="card-body">
            <div class="camera-container" style="border-radius: var(--radius-lg); overflow: hidden;">
                <img id="video" style="width: 100%; height: 100%; object-fit: cover; display: none;" alt="Camera Feed">
                <div class="camera-placeholder" id="camera-placeholder" style="height: 320px;">
                    <i class="fas fa-video" style="font-size: 56px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p style="font-size: 15px; font-weight: 500;">Camera Preview</p>
                    <p style="font-size: 13px; opacity: 0.7;">Click Start to enable camera</p>
                </div>
            </div>
            
            <div class="flex gap-2 mt-4 justify-center flex-wrap">
                <button id="start-btn" class="btn btn-primary btn-lg" onclick="startCamera()">
                    <i class="fas fa-play"></i>
                    Start Camera
                </button>
                <button id="capture-btn" class="btn btn-success btn-lg hidden" onclick="captureAndRecognize()">
                    <i class="fas fa-camera"></i>
                    Capture & Recognize
                </button>
                <button id="stop-btn" class="btn btn-secondary hidden" onclick="stopCamera()">
                    <i class="fas fa-stop"></i>
                    Stop
                </button>
            </div>
        </div>
    </div>
    
    <!-- Result Section -->
    <div id="result-section" class="card mt-4 slide-up hidden">
        <div class="card-body" id="result-content"></div>
    </div>

    <!-- Manual Entry -->
    <div class="card mt-4 slide-up">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-keyboard text-primary" style="margin-right: 8px;"></i>
                Manual Entry
            </h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('mark_manual_attendance') }}" class="flex gap-3">
                <div class="form-group" style="margin-bottom: 0; flex: 1;">
                    <input type="text" name="student_id" class="form-input" placeholder="Enter Student ID (e.g., STU001)" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i>
                    Mark Present
                </button>
            </form>
        </div>
    </div>
    
    <!-- How It Works -->
    <div class="card mt-4 slide-up">
        <div class="card-header">
            <h3 class="card-title">How It Works</h3>
        </div>
        <div class="card-body">
            <div class="grid-3" style="gap: 24px;">
                <div class="text-center">
                    <div style="width: 56px; height: 56px; margin: 0 auto 12px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 700;">1</div>
                    <div class="font-semibold mb-2">Start Camera</div>
                    <div class="text-muted" style="font-size: 13px;">Enable webcam access</div>
                </div>
                <div class="text-center">
                    <div style="width: 56px; height: 56px; margin: 0 auto 12px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 700;">2</div>
                    <div class="font-semibold mb-2">Position Face</div>
                    <div class="text-muted" style="font-size: 13px;">Look at the camera</div>
                </div>
                <div class="text-center">
                    <div style="width: 56px; height: 56px; margin: 0 auto 12px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 700;">3</div>
                    <div class="font-semibold mb-2">Capture</div>
                    <div class="text-muted" style="font-size: 13px;">Auto-mark attendance</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tips -->
    <div class="card mt-4 slide-up">
        <div class="card-body">
            <div class="flex gap-3 items-center">
                <div class="activity-icon warning"><i class="fas fa-lightbulb"></i></div>
                <div>
                    <div class="font-medium">Pro Tip</div>
                    <div class="text-muted" style="font-size: 13px;">Ensure good lighting and face the camera directly for best recognition accuracy.</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let video = document.getElementById('video');
let faceRecognitionActive = false;
let detectionInterval = null;

async function startCamera() {
    document.getElementById('result-section').classList.remove('hidden');
    document.getElementById('result-content').innerHTML = '<div class="flex items-center gap-3"><div class="activity-icon primary"><i class="fas fa-spinner fa-spin"></i></div><div><div class="font-medium">Starting camera...</div><div class="text-muted" style="font-size: 13px;">Initializing face recognition</div></div></div>';
    
    try {
        const response = await fetch('/start_face_recognition', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            faceRecognitionActive = true;
            video.src = '/get_video_feed';
            video.style.display = 'block';
            document.getElementById('camera-placeholder').style.display = 'none';
            document.getElementById('camera-status').innerHTML = '<i class="fas fa-circle text-success" style="font-size: 8px;"></i> Live';
            document.getElementById('camera-status').className = 'badge badge-success';
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('capture-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            document.getElementById('result-content').innerHTML = '<div class="alert alert-success" style="margin:0;"><i class="fas fa-check-circle"></i><div><strong>Camera Active</strong><br><span style="font-size:13px;">' + data.message + '</span></div></div>';
            
            // Start polling for detected faces
            detectionInterval = setInterval(updateDetectedFaces, 1000);
        } else {
            document.getElementById('result-content').innerHTML = '<div class="alert alert-warning" style="margin:0;"><i class="fas fa-exclamation-triangle"></i><div><strong>Camera Issue</strong><br><span style="font-size:13px;">' + data.message + '</span></div></div>';
        }
    } catch (err) {
        document.getElementById('result-content').innerHTML = '<div class="alert alert-danger" style="margin:0;"><i class="fas fa-times-circle"></i><div><strong>Error</strong><br><span style="font-size:13px;">' + err.message + '</span></div></div>';
    }
}

async function stopCamera() {
    if (detectionInterval) { clearInterval(detectionInterval); detectionInterval = null; }
    
    try {
        await fetch('/stop_face_recognition', { method: 'POST' });
    } catch (err) { console.error('Error stopping camera:', err); }
    
    faceRecognitionActive = false;
    video.src = '';
    video.style.display = 'none';
    document.getElementById('camera-placeholder').style.display = 'flex';
    document.getElementById('camera-status').innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i> Offline';
    document.getElementById('camera-status').className = 'badge badge-neutral';
    document.getElementById('start-btn').classList.remove('hidden');
    document.getElementById('capture-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('result-section').classList.add('hidden');
}

async function updateDetectedFaces() {
    if (!faceRecognitionActive) return;
    try {
        const response = await fetch('/get_detected_faces');
        const data = await response.json();
        if (data.faces && data.faces.length > 0) {
            let html = '<div class="mb-2 font-medium"><i class="fas fa-users text-primary"></i> Detected Faces:</div>';
            data.faces.forEach(face => {
                html += '<div class="flex items-center gap-2 mb-2 p-2" style="background: var(--bg-secondary); border-radius: var(--radius-sm);"><span class="font-medium">' + face.name + '</span><span class="badge badge-primary">' + Math.round(face.confidence * 100) + '%</span></div>';
            });
            document.getElementById('result-content').innerHTML = html;
        }
    } catch (err) { console.error('Error fetching faces:', err); }
}

async function captureAndRecognize() {
    document.getElementById('result-content').innerHTML = '<div class="flex items-center gap-3"><div class="activity-icon primary"><i class="fas fa-spinner fa-spin"></i></div><div><div class="font-medium">Marking attendance...</div><div class="text-muted" style="font-size: 13px;">Processing detected faces</div></div></div>';
    
    try {
        const response = await fetch('/auto_mark_attendance', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            let html = '<div class="alert alert-success" style="margin:0;"><i class="fas fa-check-circle"></i><div><strong>Success!</strong> ' + data.message;
            if (data.marked_students && data.marked_students.length > 0) {
                html += '<ul style="margin-top: 8px; padding-left: 16px;">';
                data.marked_students.forEach(s => { html += '<li>' + s.name + ' (' + s.student_id + ')</li>'; });
                html += '</ul>';
            }
            html += '</div></div>';
            document.getElementById('result-content').innerHTML = html;
        } else {
            document.getElementById('result-content').innerHTML = '<div class="alert alert-warning" style="margin:0;"><i class="fas fa-exclamation-triangle"></i><div><strong>No New Attendance</strong><br><span style="font-size:13px;">' + data.message + '</span></div></div>';
        }
    } catch (err) {
        document.getElementById('result-content').innerHTML = '<div class="alert alert-danger" style="margin:0;"><i class="fas fa-times-circle"></i><div><strong>Error</strong><br><span style="font-size:13px;">' + err.message + '</span></div></div>';
    }
}
</script>
{% endblock %}
