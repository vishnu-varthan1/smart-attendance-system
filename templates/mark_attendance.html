{% extends "base.html" %}

{% block title %}AI Face Recognition - Smart Attendance System{% endblock %}

{% block content %}
<!-- ðŸŽ¨ PREMIUM PAGE HEADER -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <div class="fade-in-up">
            <h1 class="display-5 gradient-text mb-3">
                <i class="fas fa-robot me-3 icon-gradient-primary"></i>AI Face Recognition
            </h1>
            <p class="lead text-white-50 mb-4">Advanced facial recognition for automated attendance tracking</p>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <span class="badge badge-gradient-success pulse-animation">
                    <i class="fas fa-eye me-1"></i>Real-time Detection
                </span>
                <span class="badge badge-gradient-primary">
                    <i class="fas fa-brain me-1"></i>AI Powered
                </span>
                <span class="badge badge-gradient-warning">
                    <i class="fas fa-lightning-bolt me-1"></i>Instant Recognition
                </span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ðŸŽ¨ PREMIUM CAMERA FEED -->
    <div class="col-lg-8">
        <div class="card-glass glow-effect fade-in-up hover-lift-sm">
            <div class="card-header glass-dark d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h4 class="gradient-text mb-1">
                        <i class="fas fa-video me-2 icon-gradient-primary"></i>Live Camera Feed
                    </h4>
                    <small class="text-white-75">AI-powered real-time face detection</small>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button id="startCameraBtn" class="btn btn-gradient-primary hover-scale-sm">
                        <i class="fas fa-video me-2"></i>Start Camera
                    </button>
                    <button id="startFaceRecognitionBtn" class="btn btn-gradient-success hover-scale-sm" disabled>
                        <i class="fas fa-user-check me-2"></i>Start AI
                    </button>
                    <button id="stopBtn" class="btn btn-gradient-danger hover-scale-sm" disabled>
                        <i class="fas fa-stop me-2"></i>Stop All
                    </button>
                    <button id="autoMarkBtn" class="btn btn-gradient-warning hover-scale-sm" disabled>
                        <i class="fas fa-magic me-2"></i>Auto Mark
                    </button>
                </div>
            </div>
            <div class="card-body text-center">
                <div id="cameraContainer" class="position-relative overflow-hidden glass-dark" style="height: 500px; border-radius: var(--border-radius);">
                    <div id="cameraPlaceholder" class="glass-light d-flex align-items-center justify-content-center h-100">
                        <div class="text-center p-4">
                            <div class="mb-4">
                                <div class="icon-container-gradient-primary floating mb-3" 
                                     style="width: 100px; height: 100px;">
                                    <i class="fas fa-camera fa-3x text-white"></i>
                                </div>
                            </div>
                            <h3 class="gradient-text mb-3">AI Camera Ready</h3>
                            <p class="text-white-75 mb-4">Advanced facial recognition system powered by machine learning</p>
                            
                            <div class="row g-3 text-start">
                                <div class="col-12">
                                    <div class="glass-light d-flex align-items-center p-3 rounded-3 hover-scale-sm transition-all">
                                        <div class="icon-container-gradient-primary me-3" style="width: 2.5rem; height: 2.5rem;">
                                            <i class="fas fa-eye fa-sm text-white"></i>
                                        </div>
                                        <div>
                                            <strong class="text-gradient-primary">Real-time Detection</strong>
                                            <small class="d-block text-white-75">Instant face recognition with 99% accuracy</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="glass-light d-flex align-items-center p-3 rounded-3 hover-scale-sm transition-all">
                                        <div class="icon-container-gradient-success me-3" style="width: 2.5rem; height: 2.5rem;">
                                            <i class="fas fa-robot fa-sm text-white"></i>
                                        </div>
                                        <div>
                                            <strong class="text-gradient-success">AI Powered</strong>
                                            <small class="d-block text-white-75">Machine learning algorithms for precision</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="glass-light d-flex align-items-center p-3 rounded-3 hover-scale-sm transition-all">
                                        <div class="icon-container-gradient-danger me-3" style="width: 2.5rem; height: 2.5rem;">
                                            <i class="fas fa-shield-alt fa-sm text-white"></i>
                                        </div>
                                        <div>
                                            <strong class="text-gradient-danger">Secure & Private</strong>
                                            <small class="d-block text-white-75">Data protection with encrypted processing</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <img id="videoFeed" src="" alt="AI Camera Feed" class="position-absolute top-0 start-0 w-100 h-100" 
                         style="display: none; object-fit: cover; border-radius: var(--border-radius);">
                    
                    <!-- Face Detection Overlay -->
                    <div id="faceDetectionOverlay" class="position-absolute top-0 start-0 w-100 h-100" style="display: none; pointer-events: none;">
                        <!-- Face detection boxes will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Detection Status with Enhanced Styling -->
                <div id="detectionStatus" class="mt-3">
                    <span class="badge badge-glass">
                        <i class="fas fa-circle me-1 text-secondary"></i>Detection Stopped
                    </span>
                </div>
                
                <!-- Real-time Detection Stats -->
                <div id="detectionStats" class="mt-3 d-none">
                    <div class="row g-2">
                        <div class="col-4">
                            <div class="glass-light p-2 rounded text-center">
                                <div class="text-gradient-primary fw-bold" id="facesDetected">0</div>
                                <small class="text-white-75">Faces</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="glass-light p-2 rounded text-center">
                                <div class="text-gradient-success fw-bold" id="studentsRecognized">0</div>
                                <small class="text-white-75">Recognized</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="glass-light p-2 rounded text-center">
                                <div class="text-gradient-warning fw-bold" id="confidenceAvg">0%</div>
                                <small class="text-white-75">Confidence</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detection Results -->
    <div class="col-md-4">
        <div class="card-glass hover-lift-sm fade-in-up stagger-2">
            <div class="card-header glass-dark">
                <h5 class="mb-0 gradient-text">
                    <i class="fas fa-users me-2 icon-gradient-primary"></i>Detected Faces
                </h5>
                <small class="text-white-75">Real-time face recognition results</small>
            </div>
            <div class="card-body">
                <div id="detectedFaces">
                    <div class="text-center text-white-75 empty-state-container">
                        <div class="empty-state-icon mb-3">
                            <div class="icon-container-gradient-primary floating" style="width: 4rem; height: 4rem;">
                                <i class="fas fa-search fa-2x text-white"></i>
                            </div>
                            <div class="empty-state-particles">
                                <div class="particle particle-1"></div>
                                <div class="particle particle-2"></div>
                                <div class="particle particle-3"></div>
                            </div>
                        </div>
                        <p class="mb-0">Start face recognition to detect students</p>
                    </div>
                </div>
                
                <!-- Manual Attendance Form -->
                <div class="card-glass mt-3">
                    <div class="card-header bg-primary-gradient text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-edit me-1"></i>Manual Attendance
                        </h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('mark_manual_attendance') }}" id="manualAttendanceForm">
                            <div class="mb-3">
                                <div class="form-floating-glass">
                                    <input type="text" class="form-control-glass" name="student_id" id="studentIdInput" 
                                           placeholder="Enter Student ID" required>
                                    <label for="studentIdInput" class="text-white-75">Student ID</label>
                                </div>
                                <div class="form-text text-white-50 mt-2">Enter the student's ID to mark attendance manually</div>
                            </div>
                            <button type="submit" class="btn btn-gradient-success w-100 hover-scale-sm">
                                <i class="fas fa-check me-1"></i>Mark Present
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Today's Attendance -->
        <div class="card-glass mt-3 hover-lift-sm fade-in-up stagger-3">
            <div class="card-header glass-dark d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 gradient-text">
                        <i class="fas fa-check-circle me-2 icon-gradient-success"></i>Today's Attendance
                    </h5>
                    <small class="text-white-75">Live attendance tracking</small>
                </div>
                <button id="refreshAttendance" class="btn btn-glass btn-sm hover-scale-sm" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="todayAttendance">
                    <div class="text-center text-white-75">
                        <div class="icon-container-gradient-warning floating mb-3" style="width: 3rem; height: 3rem;">
                            <i class="fas fa-calendar fa-lg text-white"></i>
                        </div>
                        <p class="mb-0">Loading attendance data...</p>
                        <div class="progress-glass mt-2" style="height: 4px;">
                            <div class="progress-bar-gradient-primary" style="width: 100%; animation: progressBarSlide 2s ease-out;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Attendance Confirmation Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content-glass">
            <div class="modal-header-glass">
                <h5 class="modal-title gradient-text">
                    <i class="fas fa-user-check me-2 icon-gradient-success"></i>Confirm Attendance
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="mb-4">
                    <div class="icon-container-gradient-success floating mb-3" style="width: 5rem; height: 5rem;">
                        <i class="fas fa-user-check fa-2x text-white"></i>
                    </div>
                </div>
                <h4 id="studentName" class="gradient-text mb-3">Student Name</h4>
                
                <!-- Confidence Meter -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-white-75">Recognition Confidence</small>
                        <span id="confidenceScore" class="badge badge-gradient-success">0%</span>
                    </div>
                    <div class="progress-glass" style="height: 8px;">
                        <div id="confidenceBar" class="progress-bar-gradient-success" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                
                <p class="text-white-75 mb-4">Mark this student as present for today's attendance?</p>
                
                <!-- Student Info Card -->
                <div class="glass-light p-3 rounded mb-4">
                    <div class="row text-start">
                        <div class="col-6">
                            <small class="text-white-50">Student ID</small>
                            <div id="modalStudentId" class="text-white fw-medium">-</div>
                        </div>
                        <div class="col-6">
                            <small class="text-white-50">Detection Time</small>
                            <div id="modalDetectionTime" class="text-white fw-medium">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer glass-dark">
                <button type="button" class="btn btn-glass hover-scale-sm" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-gradient-success hover-scale-sm" id="confirmAttendance">
                    <i class="fas fa-check me-1"></i>Mark Present
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cameraActive = false;
let faceRecognitionActive = false;
let detectionInterval;
let currentStudentId = null;

$(document).ready(function() {
    loadTodayAttendance();
    initializeAnimations();
    
    // Start camera with enhanced animations
    $('#startCameraBtn').click(function() {
        animateButtonClick($(this));
        startCamera();
    });
    
    // Start face recognition with enhanced animations
    $('#startFaceRecognitionBtn').click(function() {
        animateButtonClick($(this));
        startFaceRecognition();
    });
    
    // Stop all detection with enhanced animations
    $('#stopBtn').click(function() {
        animateButtonClick($(this));
        stopAllDetection();
    });
    
    // Auto mark attendance with enhanced animations
    $('#autoMarkBtn').click(function() {
        animateButtonClick($(this));
        autoMarkAttendance();
    });
    
    // Refresh attendance button
    $('#refreshAttendance').click(function() {
        const btn = $(this);
        btn.addClass('refreshing');
        loadTodayAttendance();
        setTimeout(() => btn.removeClass('refreshing'), 1000);
    });
    
    // Confirm attendance
    $('#confirmAttendance').click(function() {
        if (currentStudentId) {
            animateButtonClick($(this));
            markAttendance(currentStudentId);
        }
    });
    
    // Handle manual attendance form with enhanced styling
    $('#manualAttendanceForm').on('submit', function(e) {
        const studentId = $('#studentIdInput').val().trim();
        if (!studentId) {
            e.preventDefault();
            showEnhancedAlert('Please enter a student ID', 'error');
            return;
        }
        
        // Show loading state using new loading system
        const submitBtn = $(this).find('button[type="submit"]')[0];
        loadingStates.showButtonLoading(submitBtn, {
            text: 'Marking Attendance...'
        });
        
        // Reset button after a delay (form will redirect anyway)
        setTimeout(function() {
            loadingStates.hideButtonLoading(submitBtn);
        }, 3000);
    });
    
    // Auto-refresh today's attendance every 30 seconds
    setInterval(loadTodayAttendance, 30000);
    
    // Initialize real-time detection stats update
    setInterval(updateDetectionStats, 2000);
});

function startCamera() {
    // Show loading state on start camera button
    loadingStates.showButtonLoading('#startCameraBtn', {
        text: 'Starting Camera...'
    });
    
    $.ajax({
        url: '/start_detection',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                cameraActive = true;
                updateButtonStates();
                updateDetectionStatus('camera', 'Camera Active', 'primary');
                
                // Animate camera feed transition
                $('#cameraPlaceholder').fadeOut(300, function() {
                    $('#videoFeed').attr('src', '/get_video_feed?' + new Date().getTime())
                        .css({
                            'max-width': '100%',
                            'height': '500px',
                            'object-fit': 'cover',
                            'border-radius': 'var(--border-radius)',
                            'opacity': '0'
                        })
                        .show()
                        .animate({opacity: 1}, 500);
                });
                
                showEnhancedAlert('Camera started successfully', 'success');
            } else {
                showEnhancedAlert('Failed to start camera: ' + response.message, 'error');
            }
        },
        error: function() {
            showEnhancedAlert('Error starting camera', 'error');
        },
        complete: function() {
            // Hide loading state
            loadingStates.hideButtonLoading('#startCameraBtn');
        }
    });
}

function startFaceRecognition() {
    // Show loading state on face recognition button
    loadingStates.showButtonLoading('#startFaceRecognitionBtn', {
        text: 'Starting AI...'
    });
    
    $.ajax({
        url: '/start_face_recognition',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                faceRecognitionActive = true;
                updateButtonStates();
                updateDetectionStatus('ai', 'Face Recognition Active', 'success');
                
                // Show detection stats
                $('#detectionStats').removeClass('d-none').addClass('fade-in-up');
                
                // Start checking for detected faces with enhanced animations
                detectionInterval = setInterval(checkDetectedFaces, 1000);
                
                showEnhancedAlert(response.message, 'success');
            } else {
                showEnhancedAlert('Failed to start face recognition: ' + response.message, 'error');
            }
        },
        error: function() {
            showEnhancedAlert('Error starting face recognition', 'error');
        },
        complete: function() {
            // Hide loading state
            loadingStates.hideButtonLoading('#startFaceRecognitionBtn');
        }
    });
}

function stopAllDetection() {
    // Stop face recognition first
    if (faceRecognitionActive) {
        $.ajax({
            url: '/stop_face_recognition',
            method: 'POST',
            success: function(response) {
                faceRecognitionActive = false;
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                }
            }
        });
    }
    
    // Stop camera with enhanced animations
    $.ajax({
        url: '/stop_detection',
        method: 'POST',
        success: function(response) {
            cameraActive = false;
            faceRecognitionActive = false;
            
            updateButtonStates();
            updateDetectionStatus('stop', 'Detection Stopped', 'secondary');
            
            // Hide detection stats with animation
            $('#detectionStats').addClass('fade-out').addClass('d-none');
            
            // Animate video feed transition
            $('#videoFeed').animate({opacity: 0}, 300, function() {
                $(this).attr('src', '').hide();
                $('#cameraPlaceholder').fadeIn(300);
            });
            
            // Clear face detection overlay
            $('#faceDetectionOverlay').hide().empty();
            
            // Reset detected faces with animation
            resetDetectedFaces();
            
            // Stop checking for faces
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
            
            showEnhancedAlert('All detection stopped', 'info');
        },
        error: function() {
            showEnhancedAlert('Error stopping detection', 'error');
        }
    });
}

function autoMarkAttendance() {
    if (!faceRecognitionActive) {
        showAlert('Face recognition is not active', 'error');
        return;
    }
    
    $.ajax({
        url: '/auto_mark_attendance',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                loadTodayAttendance();
                
                // Show marked students
                if (response.marked_students && response.marked_students.length > 0) {
                    let studentsList = response.marked_students.map(s => 
                        `${s.name} (${s.status})`
                    ).join(', ');
                    showAlert(`Marked: ${studentsList}`, 'info');
                }
            } else {
                showAlert(response.message, 'warning');
            }
        },
        error: function() {
            showAlert('Error in auto attendance marking', 'error');
        }
    });
}

function checkDetectedFaces() {
    if (!faceRecognitionActive) return;
    
    $.get('/get_detected_faces', function(data) {
        if (data.faces && data.faces.length > 0) {
            displayDetectedFaces(data.faces);
        } else {
            $('#detectedFaces').html(`
                <div class="text-center text-muted">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>Scanning for faces...</p>
                </div>
            `);
        }
    });
}

function displayDetectedFaces(faces) {
    let html = '';
    
    faces.forEach(function(face, index) {
        const confidence = (face.confidence * 100).toFixed(1);
        const confidenceClass = confidence >= 80 ? 'success' : confidence >= 60 ? 'warning' : 'danger';
        
        if (face.student_id) {
            html += `
                <div class="card-glass mb-3 hover-lift-sm fade-in-up stagger-${index + 1}" style="border-left: 4px solid var(--success-gradient);">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="icon-container-gradient-success me-3" style="width: 2.5rem; height: 2.5rem;">
                                <i class="fas fa-user-check fa-sm text-white"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="text-gradient-success mb-1 fw-bold">${face.name}</h6>
                                <small class="text-white-75">Student ID: ${face.student_id}</small>
                            </div>
                        </div>
                        
                        <!-- Confidence Progress Bar -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-white-75">Confidence</small>
                                <span class="badge badge-gradient-${confidenceClass}">${confidence}%</span>
                            </div>
                            <div class="progress-glass" style="height: 6px;">
                                <div class="progress-bar-gradient-${confidenceClass} progress-bar-animated" 
                                     style="width: ${confidence}%; animation-delay: ${index * 0.2}s;"></div>
                            </div>
                        </div>
                        
                        <button class="btn btn-gradient-success btn-sm w-100 hover-scale-sm" 
                                onclick="showAttendanceModal(${face.student_id}, '${face.name}', ${face.confidence})">
                            <i class="fas fa-check me-1"></i>Mark Present
                        </button>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="card-glass mb-3 hover-lift-sm fade-in-up stagger-${index + 1}" style="border-left: 4px solid var(--warning-gradient);">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="icon-container-gradient-warning me-3" style="width: 2.5rem; height: 2.5rem;">
                                <i class="fas fa-user-times fa-sm text-white"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="text-gradient-warning mb-1 fw-bold">Unknown Face</h6>
                                <small class="text-white-75">Not registered in system</small>
                            </div>
                        </div>
                        
                        <!-- Confidence Progress Bar -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-white-75">Detection</small>
                                <span class="badge badge-gradient-warning">${confidence}%</span>
                            </div>
                            <div class="progress-glass" style="height: 6px;">
                                <div class="progress-bar-gradient-warning progress-bar-animated" 
                                     style="width: ${confidence}%; animation-delay: ${index * 0.2}s;"></div>
                            </div>
                        </div>
                        
                        <button class="btn btn-glass btn-sm w-100" disabled>
                            <i class="fas fa-exclamation-triangle me-1"></i>Unknown Student
                        </button>
                    </div>
                </div>
            `;
        }
    });
    
    $('#detectedFaces').html(html);
}

function showAttendanceModal(studentId, studentName, confidence) {
    currentStudentId = studentId;
    const confidencePercent = (confidence * 100).toFixed(1);
    
    $('#studentName').text(studentName);
    $('#confidenceScore').text(confidencePercent + '%');
    $('#modalStudentId').text(studentId);
    $('#modalDetectionTime').text(new Date().toLocaleTimeString());
    
    // Animate confidence bar
    $('#confidenceBar').css('width', '0%');
    setTimeout(() => {
        $('#confidenceBar').css('width', confidencePercent + '%');
    }, 300);
    
    $('#attendanceModal').modal('show');
}

function markAttendance(studentId) {
    $.ajax({
        url: '/mark_student_present',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            student_id: studentId,
            confidence: parseFloat($('#confidenceScore').text()) / 100
        }),
        success: function(response) {
            $('#attendanceModal').modal('hide');
            
            if (response.success) {
                showAlert(`${response.student_name} marked ${response.status.toLowerCase()} at ${response.time}`, 'success');
                loadTodayAttendance();
            } else {
                showAlert(response.message, 'warning');
            }
        },
        error: function() {
            $('#attendanceModal').modal('hide');
            showAlert('Error marking attendance', 'error');
        }
    });
}

function loadTodayAttendance() {
    $.get('/api/today_attendance', function(data) {
        let html = `
            <div class="text-center mb-3">
                <h5 class="gradient-text">${new Date().toLocaleDateString()}</h5>
                <span class="badge badge-gradient-success pulse-animation">${data.total_present} Present</span>
            </div>
        `;
        
        if (data.records && data.records.length > 0) {
            html += '<div class="timeline-container">';
            html += '<div class="timeline-line position-absolute"></div>';
            html += '<div class="timeline-items">';
            
            data.records.forEach(function(record, index) {
                const statusClass = record.status === 'Present' ? 'success' : 
                                  record.status === 'Late' ? 'warning' : 'secondary';
                const gradientClass = record.status === 'Present' ? 'success' : 
                                    record.status === 'Late' ? 'warning' : 'danger';
                
                html += `
                    <div class="timeline-item stagger-${index + 1}">
                        <div class="timeline-dot position-absolute">
                            <div class="timeline-dot-inner bg-${gradientClass}-gradient">
                                <i class="fas fa-${record.status === 'Present' ? 'check' : record.status === 'Late' ? 'clock' : 'times'} text-white" style="font-size: 0.6rem;"></i>
                            </div>
                        </div>
                        <div class="timeline-content glass-light p-3 hover-scale-sm">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-white">${record.student_name}</div>
                                    <small class="text-white-75">${record.student_id}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge badge-gradient-${gradientClass}">${record.status}</span>
                                    <div><small class="text-white-75">${record.time}</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        } else {
            html += `
                <div class="text-center text-white-75 empty-state-container">
                    <div class="empty-state-icon mb-3">
                        <div class="icon-container-gradient-warning floating" style="width: 3rem; height: 3rem;">
                            <i class="fas fa-calendar-times fa-lg text-white"></i>
                        </div>
                    </div>
                    <p class="mb-0">No attendance marked today</p>
                </div>
            `;
        }
        
        html += `
            <div class="text-center mt-3">
                <a href="/attendance?date=${data.date}" class="btn btn-glass btn-sm hover-scale-sm">
                    <i class="fas fa-external-link-alt me-1"></i>View All Records
                </a>
            </div>
        `;
        
        $('#todayAttendance').html(html);
    }).fail(function() {
        $('#todayAttendance').html(`
            <div class="text-center text-white-75">
                <div class="icon-container-gradient-danger mb-3" style="width: 3rem; height: 3rem;">
                    <i class="fas fa-exclamation-triangle fa-lg text-white"></i>
                </div>
                <p class="mb-0">Error loading attendance data</p>
            </div>
        `);
    });
}

// Enhanced alert system with glass-morphism styling
function showEnhancedAlert(message, type) {
    const alertClass = type === 'error' ? 'danger' : type;
    const iconClass = type === 'success' ? 'check-circle' : 
                     type === 'error' || type === 'danger' ? 'exclamation-triangle' : 
                     type === 'warning' ? 'exclamation-circle' : 'info-circle';
    
    const alertHtml = `
        <div class="alert alert-glass-${alertClass} alert-dismissible fade show slide-in-down" role="alert">
            <i class="fas fa-${iconClass} me-2"></i>${message}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove existing alerts with animation
    $('.alert').addClass('fade-out').fadeOut(300, function() {
        $(this).remove();
    });
    
    // Add new alert at the top of the container
    setTimeout(() => {
        $('.container').first().prepend(alertHtml);
    }, 300);
    
    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.alert').addClass('fade-out').fadeOut(500, function() {
            $(this).remove();
        });
    }, 5000);
}

// Initialize animations and UI enhancements
function initializeAnimations() {
    // Add staggered animation delays to existing elements
    $('.card-glass').each(function(index) {
        $(this).addClass(`stagger-${index + 1}`);
    });
    
    // Initialize floating particles for empty states
    $('.empty-state-particles').each(function() {
        if ($(this).children().length === 0) {
            for (let i = 1; i <= 3; i++) {
                $(this).append(`<div class="particle particle-${i}"></div>`);
            }
        }
    });
}

// Animate button clicks with enhanced feedback
function animateButtonClick(button) {
    button.addClass('scale-in-bounce');
    setTimeout(() => {
        button.removeClass('scale-in-bounce');
    }, 600);
}

// Update button states with enhanced styling
function updateButtonStates() {
    $('#startCameraBtn').prop('disabled', cameraActive);
    $('#startFaceRecognitionBtn').prop('disabled', !cameraActive || faceRecognitionActive);
    $('#stopBtn').prop('disabled', !cameraActive && !faceRecognitionActive);
    $('#autoMarkBtn').prop('disabled', !faceRecognitionActive);
    
    // Add visual state indicators
    if (cameraActive) {
        $('#startCameraBtn').addClass('btn-state-active');
    } else {
        $('#startCameraBtn').removeClass('btn-state-active');
    }
    
    if (faceRecognitionActive) {
        $('#startFaceRecognitionBtn').addClass('btn-state-active');
    } else {
        $('#startFaceRecognitionBtn').removeClass('btn-state-active');
    }
}

// Update detection status with enhanced styling and animations
function updateDetectionStatus(type, message, statusClass) {
    const iconClass = type === 'camera' ? 'video' : 
                     type === 'ai' ? 'brain' : 
                     type === 'stop' ? 'stop-circle' : 'circle';
    
    const statusHtml = `
        <span class="badge badge-gradient-${statusClass} pulse-animation">
            <i class="fas fa-${iconClass} me-1"></i>${message}
        </span>
    `;
    
    $('#detectionStatus').html(statusHtml);
}

// Reset detected faces with animation
function resetDetectedFaces() {
    $('#detectedFaces').fadeOut(300, function() {
        $(this).html(`
            <div class="text-center text-white-75 empty-state-container">
                <div class="empty-state-icon mb-3">
                    <div class="icon-container-gradient-primary floating" style="width: 4rem; height: 4rem;">
                        <i class="fas fa-search fa-2x text-white"></i>
                    </div>
                    <div class="empty-state-particles">
                        <div class="particle particle-1"></div>
                        <div class="particle particle-2"></div>
                        <div class="particle particle-3"></div>
                    </div>
                </div>
                <p class="mb-0">Start face recognition to detect students</p>
            </div>
        `).fadeIn(300);
    });
}

// Update real-time detection statistics
function updateDetectionStats() {
    if (!faceRecognitionActive) return;
    
    // This would typically get real data from the server
    // For now, we'll simulate some stats
    const facesCount = $('#detectedFaces .card-glass').length;
    const recognizedCount = $('#detectedFaces .text-gradient-success').length;
    const avgConfidence = Math.floor(Math.random() * 20) + 80; // Simulate 80-100%
    
    // Animate counter updates
    animateCounter('#facesDetected', facesCount);
    animateCounter('#studentsRecognized', recognizedCount);
    animateCounter('#confidenceAvg', avgConfidence, '%');
}

// Animate counter with smooth transitions
function animateCounter(selector, targetValue, suffix = '') {
    const element = $(selector);
    const currentValue = parseInt(element.text()) || 0;
    
    if (currentValue !== targetValue) {
        $({counter: currentValue}).animate({counter: targetValue}, {
            duration: 1000,
            easing: 'swing',
            step: function() {
                element.text(Math.ceil(this.counter) + suffix);
            },
            complete: function() {
                element.text(targetValue + suffix);
            }
        });
    }
}

// Legacy function for backward compatibility
function showAlert(message, type) {
    showEnhancedAlert(message, type);
}

// Cleanup on page unload
$(window).on('beforeunload', function() {
    if (cameraActive || faceRecognitionActive) {
        stopAllDetection();
    }
});

// Add CSS for button states
$('<style>')
    .prop('type', 'text/css')
    .html(`
        .btn-state-active {
            position: relative;
            overflow: hidden;
        }
        .btn-state-active::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .loading-state {
            pointer-events: none;
            opacity: 0.8;
        }
        .fade-out {
            opacity: 0 !important;
            transform: translateY(-10px) !important;
        }
    `)
    .appendTo('head');
</script>
{% endblock %}