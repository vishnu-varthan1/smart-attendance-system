name: Release Drafter

on:
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-release-draft:
    name: Draft Release
    runs-on: ubuntu-latest
    steps:
      - uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            const lastRelease = releases[0];
            const since = lastRelease ? lastRelease.created_at : '2020-01-01T00:00:00Z';
            
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: since,
              per_page: 100
            });
            
            let changelog = '## Recent Changes\n\n';
            
            const categories = {
              feat: { title: 'Features', items: [] },
              fix: { title: 'Bug Fixes', items: [] },
              docs: { title: 'Documentation', items: [] },
              refactor: { title: 'Refactoring', items: [] },
              test: { title: 'Tests', items: [] },
              chore: { title: 'Maintenance', items: [] },
              other: { title: 'Other Changes', items: [] }
            };
            
            for (const commit of commits) {
              const msg = commit.commit.message.split('\n')[0];
              const sha = commit.sha.substring(0, 7);
              const entry = `- ${msg} (${sha})`;
              
              if (msg.startsWith('feat')) categories.feat.items.push(entry);
              else if (msg.startsWith('fix')) categories.fix.items.push(entry);
              else if (msg.startsWith('docs')) categories.docs.items.push(entry);
              else if (msg.startsWith('refactor')) categories.refactor.items.push(entry);
              else if (msg.startsWith('test')) categories.test.items.push(entry);
              else if (msg.startsWith('chore')) categories.chore.items.push(entry);
              else categories.other.items.push(entry);
            }
            
            for (const [key, cat] of Object.entries(categories)) {
              if (cat.items.length > 0) {
                changelog += `### ${cat.title}\n${cat.items.join('\n')}\n\n`;
              }
            }
            
            console.log(changelog);
        continue-on-error: true
