{% extends "base.html" %}

{% block title %}Register Student - Smart Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-gradient-primary fade-in-left">
                <i class="fas fa-user-plus me-2"></i>Register New Student
            </h1>
            <a href="{{ url_for('students') }}" class="btn btn-glass hover-lift">
                <i class="fas fa-arrow-left me-1"></i>Back to Students
            </a>
        </div>
    </div>
</div>

<!-- Multi-Step Progress Indicator -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card-glass fade-in-up">
            <div class="card-body p-3">
                <div class="wizard-progress">
                    <div class="progress-container">
                        <div class="progress progress-glass">
                            <div class="progress-bar progress-bar-gradient-primary" id="wizardProgress" 
                                 role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div class="steps-container mt-3">
                        <div class="step-item active" data-step="1">
                            <div class="step-circle">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="step-label">Basic Info</div>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="step-circle">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="step-label">Contact</div>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="step-circle">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="step-label">Academic</div>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="step-circle">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="step-label">Photo</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card-glass fade-in-up stagger-2">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="studentForm">
                    <!-- Step 1: Basic Information -->
                    <div class="wizard-step active" id="step1">
                        <div class="step-header mb-4">
                            <h4 class="text-gradient-primary mb-2">
                                <i class="fas fa-user me-2"></i>Basic Information
                            </h4>
                            <p class="text-muted">Enter the student's basic identification details</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <input type="text" class="form-control form-control-glass" id="student_id" 
                                           name="student_id" value="{{ data.student_id if data else '' }}" 
                                           placeholder="" required>
                                    <label for="student_id">Student ID </label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <input type="text" class="form-control form-control-glass" id="name" 
                                           name="name" value="{{ data.name if data else '' }}" 
                                           placeholder="" required>
                                    <label for="name">Full Name </label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <input type="text" class="form-control form-control-glass" id="roll_number" 
                                           name="roll_number" value="{{ data.roll_number if data else '' }}" 
                                           placeholder="">
                                    <label for="roll_number">Roll Number</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Contact Information -->
                    <div class="wizard-step" id="step2">
                        <div class="step-header mb-4">
                            <h4 class="text-gradient-primary mb-2">
                                <i class="fas fa-envelope me-2"></i>Contact Information
                            </h4>
                            <p class="text-muted">Provide contact details for communication</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <input type="email" class="form-control form-control-glass" id="email" 
                                           name="email" value="{{ data.email if data else '' }}" 
                                           placeholder="Email Address" required>
                                    <label for="email">Email Address *</label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <input type="tel" class="form-control form-control-glass" id="phone" 
                                           name="phone" value="{{ data.phone if data else '' }}" 
                                           placeholder="Phone Number">
                                    <label for="phone">Phone Number</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Academic Information -->
                    <div class="wizard-step" id="step3">
                        <div class="step-header mb-4">
                            <h4 class="text-gradient-primary mb-2">
                                <i class="fas fa-graduation-cap me-2"></i>Academic Information
                            </h4>
                            <p class="text-muted">Enter academic details and course information</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <select class="form-select-glass" id="department" name="department" required>
                                        <option value="" disabled selected>Choose Department</option>
                                        <option value="Computer Science">Computer Science</option>
                                        <option value="Information Technology">Information Technology</option>
                                        <option value="Electronics & Communication">Electronics & Communication</option>
                                        <option value="Mechanical Engineering">Mechanical Engineering</option>
                                        <option value="Civil Engineering">Civil Engineering</option>
                                        <option value="Electrical Engineering">Electrical Engineering</option>
                                    </select>
                                    <label for="department">Department *</label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <select class="form-select-glass" id="course" name="course" required>
                                        <option value="" disabled selected>Choose Course</option>
                                        <option value="B.Tech">B.Tech</option>
                                        <option value="M.Tech">M.Tech</option>
                                        <option value="BCA">BCA</option>
                                        <option value="MCA">MCA</option>
                                        <option value="B.Sc">B.Sc</option>
                                        <option value="M.Sc">M.Sc</option>
                                    </select>
                                    <label for="course">Course *</label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="form-floating-glass">
                                    <select class="form-select-glass" id="year" name="year" required>
                                        <option value="" disabled selected>Choose Year</option>
                                        <option value="1st Year">1st Year</option>
                                        <option value="2nd Year">2nd Year</option>
                                        <option value="3rd Year">3rd Year</option>
                                        <option value="4th Year">4th Year</option>
                                    </select>
                                    <label for="year">Year *</label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="form-floating-glass">
                                    <input type="text" class="form-control form-control-glass text-uppercase" 
                                           id="section" name="section" value="{{ data.section if data else '' }}" 
                                           maxlength="3" placeholder="Section" required>
                                    <label for="section">Section *</label>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="form-floating-glass">
                                    <select class="form-select-glass" id="semester" name="semester">
                                        <option value="" disabled selected>Choose Semester</option>
                                        <option value="1st Sem">1st Sem</option>
                                        <option value="2nd Sem">2nd Sem</option>
                                        <option value="3rd Sem">3rd Sem</option>
                                        <option value="4th Sem">4th Sem</option>
                                        <option value="5th Sem">5th Sem</option>
                                        <option value="6th Sem">6th Sem</option>
                                        <option value="7th Sem">7th Sem</option>
                                        <option value="8th Sem">8th Sem</option>
                                    </select>
                                    <label for="semester">Semester</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-floating-glass">
                                    <input type="text" class="form-control form-control-glass" id="batch" 
                                           name="batch" value="{{ data.batch if data else '' }}" 
                                           placeholder="Batch Year">
                                    <label for="batch">Batch Year</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Photo Upload/Capture -->
                    <div class="wizard-step" id="step4">
                        <div class="step-header mb-4">
                            <h4 class="text-gradient-primary mb-2">
                                <i class="fas fa-camera me-2"></i>Student Photo
                            </h4>
                            <p class="text-muted">Upload or capture a clear photo for face recognition</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Drag and Drop Upload Area -->
                                <div class="photo-upload-container mb-4">
                                    <div class="drag-drop-area" id="dragDropArea">
                                        <div class="drag-drop-content">
                                            <div class="icon-container-gradient-primary mb-3">
                                                <i class="fas fa-cloud-upload-alt fa-2x"></i>
                                            </div>
                                            <h5 class="text-gradient-primary mb-2">Drag & Drop Photo</h5>
                                            <p class="text-muted mb-3">or click to browse files</p>
                                            <button type="button" class="btn btn-gradient-primary" id="browseBtn">
                                                <i class="fas fa-folder-open me-1"></i>Browse Files
                                            </button>
                                        </div>
                                        <input type="file" class="d-none" id="image" name="image" accept="image/*">
                                    </div>
                                </div>
                                
                                <!-- Camera Capture Section -->
                                <div class="camera-section mb-4">
                                    <div class="d-grid mb-3">
                                        <button type="button" class="btn btn-gradient-success hover-lift" id="takePhotoBtn">
                                            <i class="fas fa-camera me-1"></i>Take Photo with Camera
                                        </button>
                                    </div>
                                    
                                    <!-- Camera Controls (Hidden by default) -->
                                    <div id="cameraSection" class="camera-container" style="display: none;">
                                        <div class="camera-frame">
                                            <video id="cameraVideo" autoplay class="camera-video"></video>
                                            <canvas id="captureCanvas" style="display: none;"></canvas>
                                        </div>
                                        <div class="camera-controls mt-3">
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-gradient-primary" id="capturePhoto">
                                                    <i class="fas fa-camera me-1"></i>Capture Photo
                                                </button>
                                                <button type="button" class="btn btn-gradient-warning" id="retakePhoto" style="display: none;">
                                                    <i class="fas fa-redo me-1"></i>Retake Photo
                                                </button>
                                                <button type="button" class="btn btn-glass" id="stopCamera">
                                                    <i class="fas fa-stop me-1"></i>Stop Camera
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- Photo Preview -->
                                <div class="photo-preview-container">
                                    <div id="imagePreview" class="preview-area" style="display: none;">
                                        <div class="preview-header mb-3">
                                            <h6 class="text-gradient-primary mb-0">
                                                <i class="fas fa-eye me-2"></i>Photo Preview
                                            </h6>
                                        </div>
                                        <div class="preview-image-container">
                                            <img id="previewImg" src="" alt="Preview" class="preview-image">
                                            <div class="preview-overlay">
                                                <button type="button" class="btn btn-glass btn-sm" id="removePhoto">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Photo Guidelines -->
                                    <div class="alert-glass-info p-3">
                                        <h6 class="text-gradient-primary mb-3">
                                            <i class="fas fa-lightbulb me-2"></i>Photo Guidelines
                                        </h6>
                                        <ul class="mb-0 small">
                                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Ensure good lighting</li>
                                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Face should be centered</li>
                                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Remove glasses if possible</li>
                                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Look directly at camera</li>
                                            <li class="mb-0"><i class="fas fa-check text-success me-2"></i>Neutral expression works best</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="wizard-navigation">
                        <div class="d-flex justify-content-between align-items-center pt-4 border-top">
                            <button type="button" class="btn btn-glass" id="prevBtn" style="display: none;">
                                <i class="fas fa-arrow-left me-1"></i>Previous
                            </button>
                            
                            <div class="step-info">
                                <span class="text-muted">Step <span id="currentStep">1</span> of 4</span>
                            </div>
                            
                            <div class="next-submit-container">
                                <button type="button" class="btn btn-gradient-primary" id="nextBtn">
                                    Next<i class="fas fa-arrow-right ms-1"></i>
                                </button>
                                <button type="submit" class="btn btn-gradient-success btn-lg" id="submitBtn" style="display: none;">
                                    <i class="fas fa-user-plus me-1"></i>Register Student
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ===== WIZARD PROGRESS STYLES ===== */
.wizard-progress {
    position: relative;
}

.progress-container {
    position: relative;
    margin-bottom: 1rem;
}

.steps-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    transition: all var(--transition-normal) var(--easing-smooth);
}

.step-circle {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 2px solid var(--glass-border);
    color: var(--bs-body-color);
    font-size: 1.1rem;
    transition: all var(--transition-normal) var(--easing-smooth);
    position: relative;
    z-index: 2;
}

.step-item.active .step-circle {
    background: var(--primary-gradient);
    border-color: transparent;
    color: white;
    transform: scale(1.1);
    box-shadow: var(--shadow-glow);
}

.step-item.completed .step-circle {
    background: var(--success-gradient);
    border-color: transparent;
    color: white;
    box-shadow: var(--shadow-success);
}

.step-label {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    font-weight: var(--font-weight-medium);
    color: var(--bs-body-color);
    transition: all var(--transition-normal) var(--easing-smooth);
}

.step-item.active .step-label {
    color: var(--bs-primary);
    font-weight: var(--font-weight-bold);
}

.step-item.completed .step-label {
    color: var(--bs-success);
    font-weight: var(--font-weight-bold);
}

/* Step connecting lines */
.step-item:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 1.5rem;
    left: calc(50% + 1.5rem);
    right: calc(-50% + 1.5rem);
    height: 2px;
    background: var(--glass-border);
    z-index: 1;
    transition: all var(--transition-normal) var(--easing-smooth);
}

.step-item.completed:not(:last-child)::after {
    background: var(--success-gradient);
}

/* ===== WIZARD STEP STYLES ===== */
.wizard-step {
    display: none;
    animation: fadeInUp var(--transition-normal) var(--easing-smooth);
}

.wizard-step.active {
    display: block;
}

.step-header {
    text-align: center;
    margin-bottom: 2rem;
}

.step-header h4 {
    margin-bottom: 0.5rem;
}

.step-header p {
    font-size: 1rem;
    margin-bottom: 0;
}

/* ===== ENHANCED FORM STYLES ===== */
.form-floating-glass {
    position: relative;
    margin-bottom: 1rem;
}

.form-floating-glass .form-control-glass {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius-sm);
    transition: all var(--transition-normal) var(--easing-smooth);
    padding: 1rem 0.75rem 0.25rem 0.75rem;
    height: calc(3.5rem + 2px);
}

.form-floating-glass .form-control-glass:focus {
    background: var(--glass-bg-light);
    border-color: rgba(102, 126, 234, 0.5);
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    outline: 0;
}

.form-floating-glass label {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    padding: 1rem 0.75rem;
    pointer-events: none;
    border: 1px solid transparent;
    transform-origin: 0 0;
    transition: all var(--transition-normal) var(--easing-smooth);
    color: rgba(var(--bs-body-color-rgb), 0.65);
    font-weight: var(--font-weight-medium);
}

.form-floating-glass .form-control-glass:focus ~ label,
.form-floating-glass .form-control-glass:not(:placeholder-shown) ~ label {
    opacity: 0.65;
    transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
    color: rgba(102, 126, 234, 0.8);
}

.form-floating-glass .form-select {
    padding-top: 1.625rem;
    padding-bottom: 0.625rem;
}

.form-floating-glass .form-select ~ label {
    opacity: 0.65;
    transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
}

/* Validation Styles */
.form-control-glass.is-invalid {
    border-color: rgba(255, 107, 107, 0.5);
    box-shadow: 0 0 0 0.25rem rgba(255, 107, 107, 0.25);
}

.form-control-glass.is-valid {
    border-color: rgba(67, 233, 123, 0.5);
    box-shadow: 0 0 0 0.25rem rgba(67, 233, 123, 0.25);
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #dc3545;
}

.is-invalid ~ .invalid-feedback {
    display: block;
}

/* ===== PHOTO UPLOAD STYLES ===== */
.photo-upload-container {
    position: relative;
}

.drag-drop-area {
    border: 2px dashed var(--glass-border);
    border-radius: var(--border-radius);
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 2rem;
    text-align: center;
    transition: all var(--transition-normal) var(--easing-smooth);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.drag-drop-area:hover {
    border-color: rgba(102, 126, 234, 0.5);
    background: var(--glass-bg-light);
    transform: translateY(-2px);
}

.drag-drop-area.drag-over {
    border-color: rgba(102, 126, 234, 0.8);
    background: var(--glass-bg-light);
    transform: scale(1.02);
    box-shadow: var(--shadow-glow);
}

.drag-drop-content h5 {
    margin-bottom: 0.5rem;
}

.drag-drop-content p {
    margin-bottom: 1rem;
}

/* Camera Section Styles */
.camera-section {
    position: relative;
}

.camera-container {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    animation: fadeInUp var(--transition-normal) var(--easing-smooth);
}

.camera-frame {
    position: relative;
    border-radius: var(--border-radius);
    overflow: hidden;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.camera-video {
    width: 100%;
    max-width: 400px;
    height: auto;
    border-radius: var(--border-radius-sm);
}

.camera-controls {
    margin-top: 1rem;
}

/* Photo Preview Styles */
.photo-preview-container {
    position: relative;
}

.preview-area {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    animation: fadeInUp var(--transition-normal) var(--easing-smooth);
}

.preview-image-container {
    position: relative;
    display: inline-block;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-light);
}

.preview-image {
    width: 100%;
    max-width: 250px;
    height: auto;
    display: block;
    border-radius: var(--border-radius-sm);
}

.preview-overlay {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: all var(--transition-normal) var(--easing-smooth);
}

.preview-image-container:hover .preview-overlay {
    opacity: 1;
}

/* ===== WIZARD NAVIGATION STYLES ===== */
.wizard-navigation {
    margin-top: 2rem;
}

.step-info {
    font-weight: var(--font-weight-medium);
    color: var(--bs-body-color);
}

.next-submit-container {
    position: relative;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
    .steps-container {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .step-item {
        flex: 0 0 calc(50% - 0.5rem);
        margin-bottom: 1rem;
    }
    
    .step-item:not(:last-child)::after {
        display: none;
    }
    
    .step-circle {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1rem;
    }
    
    .step-label {
        font-size: 0.75rem;
    }
    
    .drag-drop-area {
        padding: 1.5rem 1rem;
    }
    
    .camera-container {
        padding: 1rem;
    }
    
    .preview-area {
        padding: 1rem;
    }
    
    .wizard-navigation .d-flex {
        flex-direction: column;
        gap: 1rem;
    }
    
    .step-info {
        order: -1;
        text-align: center;
    }
}

/* ===== ANIMATION ENHANCEMENTS ===== */
@keyframes stepActivate {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1.1);
    }
}

.step-item.activating .step-circle {
    animation: stepActivate 0.3s var(--easing-smooth);
}

/* Loading States */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 1rem;
    height: 1rem;
    top: 50%;
    left: 50%;
    margin-left: -0.5rem;
    margin-top: -0.5rem;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Success Animation */
@keyframes successPulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(67, 233, 123, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(67, 233, 123, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(67, 233, 123, 0);
    }
}

.success-animation {
    animation: successPulse 0.6s var(--easing-smooth);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let stream = null;
    let capturedImageData = null;
    let currentStep = 1;
    const totalSteps = 4;
    
    // ===== WIZARD NAVIGATION FUNCTIONS =====
    function showStep(step) {
        // Hide all steps
        $('.wizard-step').removeClass('active');
        
        // Show current step
        $(`#step${step}`).addClass('active');
        
        // Update progress bar
        const progress = (step / totalSteps) * 100;
        $('#wizardProgress').css('width', progress + '%').attr('aria-valuenow', progress);
        
        // Update step indicators
        $('.step-item').removeClass('active completed');
        for (let i = 1; i <= totalSteps; i++) {
            const $stepItem = $(`.step-item[data-step="${i}"]`);
            if (i < step) {
                $stepItem.addClass('completed');
                $stepItem.find('.step-circle').html('<i class="fas fa-check"></i>');
            } else if (i === step) {
                $stepItem.addClass('active activating');
                setTimeout(() => $stepItem.removeClass('activating'), 300);
                $stepItem.find('.step-circle').html(`<i class="fas fa-${getStepIcon(i)}"></i>`);
            } else {
                $stepItem.find('.step-circle').html(`<i class="fas fa-${getStepIcon(i)}"></i>`);
            }
        }
        
        // Update navigation buttons
        $('#prevBtn').toggle(step > 1);
        $('#nextBtn').toggle(step < totalSteps);
        $('#submitBtn').toggle(step === totalSteps);
        $('#currentStep').text(step);
        
        // Scroll to top
        $('html, body').animate({scrollTop: 0}, 300);
    }
    
    function getStepIcon(step) {
        const icons = ['user', 'envelope', 'graduation-cap', 'camera'];
        return icons[step - 1] || 'circle';
    }
    
    function validateStep(step) {
        let isValid = true;
        let errors = [];
        
        // Clear previous validation
        $('.form-control-glass').removeClass('is-invalid is-valid');
        $('.invalid-feedback').empty();
        
        switch (step) {
            case 1: // Basic Information
                isValid = validateBasicInfo(errors);
                break;
            case 2: // Contact Information
                isValid = validateContactInfo(errors);
                break;
            case 3: // Academic Information
                isValid = validateAcademicInfo(errors);
                break;
            case 4: // Photo
                isValid = validatePhoto(errors);
                break;
        }
        
        if (!isValid) {
            showValidationErrors(errors);
        }
        
        return isValid;
    }
    
    function validateBasicInfo(errors) {
        let isValid = true;
        
        // Student ID validation
        const studentId = $('#student_id').val().trim();
        if (!studentId) {
            $('#student_id').addClass('is-invalid');
            $('#student_id').siblings('.invalid-feedback').text('Student ID is required');
            errors.push('Student ID is required');
            isValid = false;
        } else if (studentId.length < 3) {
            $('#student_id').addClass('is-invalid');
            $('#student_id').siblings('.invalid-feedback').text('Student ID must be at least 3 characters');
            errors.push('Student ID must be at least 3 characters');
            isValid = false;
        } else {
            $('#student_id').addClass('is-valid');
        }
        
        // Name validation
        const name = $('#name').val().trim();
        if (!name) {
            $('#name').addClass('is-invalid');
            $('#name').siblings('.invalid-feedback').text('Full name is required');
            errors.push('Full name is required');
            isValid = false;
        } else if (name.length < 2) {
            $('#name').addClass('is-invalid');
            $('#name').siblings('.invalid-feedback').text('Name must be at least 2 characters');
            errors.push('Name must be at least 2 characters');
            isValid = false;
        } else {
            $('#name').addClass('is-valid');
        }
        
        return isValid;
    }
    
    function validateContactInfo(errors) {
        let isValid = true;
        
        // Email validation
        const email = $('#email').val().trim();
        if (!email) {
            $('#email').addClass('is-invalid');
            $('#email').siblings('.invalid-feedback').text('Email address is required');
            errors.push('Email address is required');
            isValid = false;
        } else if (!isValidEmail(email)) {
            $('#email').addClass('is-invalid');
            $('#email').siblings('.invalid-feedback').text('Please enter a valid email address');
            errors.push('Please enter a valid email address');
            isValid = false;
        } else {
            $('#email').addClass('is-valid');
        }
        
        // Phone validation (optional but if provided, should be valid)
        const phone = $('#phone').val().trim();
        if (phone && phone.length < 10) {
            $('#phone').addClass('is-invalid');
            $('#phone').siblings('.invalid-feedback').text('Phone number should be at least 10 digits');
            errors.push('Phone number should be at least 10 digits');
            isValid = false;
        } else if (phone) {
            $('#phone').addClass('is-valid');
        }
        
        return isValid;
    }
    
    function validateAcademicInfo(errors) {
        let isValid = true;
        
        // Department validation
        const department = $('#department').val();
        if (!department) {
            $('#department').addClass('is-invalid');
            $('#department').siblings('.invalid-feedback').text('Department is required');
            errors.push('Department is required');
            isValid = false;
        } else {
            $('#department').addClass('is-valid');
        }
        
        // Course validation
        const course = $('#course').val();
        if (!course) {
            $('#course').addClass('is-invalid');
            $('#course').siblings('.invalid-feedback').text('Course is required');
            errors.push('Course is required');
            isValid = false;
        } else {
            $('#course').addClass('is-valid');
        }
        
        // Year validation
        const year = $('#year').val();
        if (!year) {
            $('#year').addClass('is-invalid');
            $('#year').siblings('.invalid-feedback').text('Year is required');
            errors.push('Year is required');
            isValid = false;
        } else {
            $('#year').addClass('is-valid');
        }
        
        // Section validation
        const section = $('#section').val().trim();
        if (!section) {
            $('#section').addClass('is-invalid');
            $('#section').siblings('.invalid-feedback').text('Section is required');
            errors.push('Section is required');
            isValid = false;
        } else {
            $('#section').addClass('is-valid');
        }
        
        return isValid;
    }
    
    function validatePhoto(errors) {
        const imageFile = $('#image')[0].files[0];
        if (!imageFile && !capturedImageData) {
            errors.push('Student photo is required - either upload a file or take a photo');
            return false;
        }
        return true;
    }
    
    function showValidationErrors(errors) {
        if (errors.length > 0) {
            // Create toast notification for errors
            showToast('Please fix the following errors:<br>• ' + errors.join('<br>• '), 'error');
        }
    }
    
    function showToast(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const toastClass = type === 'error' ? 'alert-glass-danger' : 
                          type === 'success' ? 'alert-glass-success' : 'alert-glass-info';
        
        const toast = $(`
            <div id="${toastId}" class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
                <div>${message}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            toast.alert('close');
        }, 5000);
    }
    
    // ===== WIZARD NAVIGATION EVENT HANDLERS =====
    $('#nextBtn').click(function() {
        if (validateStep(currentStep)) {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
    });
    
    $('#prevBtn').click(function() {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });
    
    // Step indicator click navigation
    $('.step-item').click(function() {
        const targetStep = parseInt($(this).data('step'));
        if (targetStep < currentStep || validateStep(currentStep)) {
            currentStep = targetStep;
            showStep(currentStep);
        }
    });
    
    // ===== DRAG AND DROP FUNCTIONALITY =====
    const $dragDropArea = $('#dragDropArea');
    const $fileInput = $('#image');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        $dragDropArea[0].addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        $dragDropArea[0].addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        $dragDropArea[0].addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    $dragDropArea[0].addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        $dragDropArea.addClass('drag-over');
    }
    
    function unhighlight(e) {
        $dragDropArea.removeClass('drag-over');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                $fileInput[0].files = files;
                handleFileSelect(file);
            } else {
                showToast('Please select a valid image file', 'error');
            }
        }
    }
    
    // Browse button click
    $('#browseBtn').click(function() {
        $fileInput.click();
    });
    
    // Drag drop area click
    $dragDropArea.click(function() {
        $fileInput.click();
    });
    
    // File input change
    $fileInput.change(function() {
        const file = this.files[0];
        if (file) {
            handleFileSelect(file);
        }
    });
    
    function handleFileSelect(file) {
        if (file.type.startsWith('image/')) {
            // Show upload progress
            const uploadContainer = document.createElement('div');
            uploadContainer.id = 'uploadProgressContainer';
            document.querySelector('.photo-upload-container').appendChild(uploadContainer);
            
            const uploadElement = loadingStates.showUploadProgress(uploadContainer, {
                fileName: file.name,
                progress: 0,
                onCancel: () => {
                    uploadContainer.remove();
                    $fileInput.val('');
                }
            });
            
            const reader = new FileReader();
            
            // Simulate upload progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 90) {
                    progress = 90;
                    clearInterval(progressInterval);
                }
                loadingStates.updateUploadProgress(uploadElement, Math.round(progress), {
                    status: 'Processing image...'
                });
            }, 100);
            
            reader.onload = function(e) {
                // Complete the progress
                loadingStates.updateUploadProgress(uploadElement, 100, {
                    status: 'Upload complete!'
                });
                
                setTimeout(() => {
                    showImagePreview(e.target.result);
                    capturedImageData = null; // Clear captured data
                    uploadContainer.remove();
                }, 1000);
            };
            
            reader.onerror = function() {
                uploadContainer.remove();
                showToast('Error reading file', 'error');
            };
            
            reader.readAsDataURL(file);
        } else {
            showToast('Please select a valid image file', 'error');
        }
    }
    
    function showImagePreview(src) {
        $('#previewImg').attr('src', src);
        $('#imagePreview').show().addClass('fade-in-up');
        
        // Update drag drop area to show success
        $dragDropArea.addClass('success-animation');
        setTimeout(() => $dragDropArea.removeClass('success-animation'), 600);
    }
    
    // Remove photo button
    $('#removePhoto').click(function() {
        $('#imagePreview').hide();
        $fileInput.val('');
        capturedImageData = null;
    });
    
    // ===== REAL-TIME VALIDATION =====
    // Auto-uppercase section input
    $('#section').on('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Real-time validation on input
    $('.form-control-glass').on('input blur', function() {
        const $field = $(this);
        const fieldId = $field.attr('id');
        
        // Remove validation classes first
        $field.removeClass('is-invalid is-valid');
        
        // Validate based on field
        let isValid = true;
        let errorMessage = '';
        
        switch (fieldId) {
            case 'student_id':
                const studentId = $field.val().trim();
                if (studentId && studentId.length < 3) {
                    isValid = false;
                    errorMessage = 'Student ID must be at least 3 characters';
                }
                break;
            case 'name':
                const name = $field.val().trim();
                if (name && name.length < 2) {
                    isValid = false;
                    errorMessage = 'Name must be at least 2 characters';
                }
                break;
            case 'email':
                const email = $field.val().trim();
                if (email && !isValidEmail(email)) {
                    isValid = false;
                    errorMessage = 'Please enter a valid email address';
                }
                break;
            case 'phone':
                const phone = $field.val().trim();
                if (phone && phone.length < 10) {
                    isValid = false;
                    errorMessage = 'Phone number should be at least 10 digits';
                }
                break;
        }
        
        if ($field.val().trim() !== '') {
            if (isValid) {
                $field.addClass('is-valid');
            } else {
                $field.addClass('is-invalid');
                $field.siblings('.invalid-feedback').text(errorMessage);
            }
        }
    });
    
    // ===== CAMERA FUNCTIONALITY =====
    $('#takePhotoBtn').click(function() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showToast('Camera access is not supported in this browser', 'error');
            return;
        }
        
        const $btn = $(this);
        $btn.addClass('btn-loading').prop('disabled', true);
        
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        })
        .then(function(mediaStream) {
            stream = mediaStream;
            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;
            video.play();
            
            $('#cameraSection').show().addClass('fade-in-up');
            $btn.hide();
        })
        .catch(function(err) {
            showToast('Error accessing camera: ' + err.message, 'error');
        })
        .finally(function() {
            $btn.removeClass('btn-loading').prop('disabled', false);
        });
    });
    
    // Capture Photo
    $('#capturePhoto').click(function() {
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('captureCanvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas dimensions to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        capturedImageData = dataURL;
        
        showImagePreview(dataURL);
        
        $('#capturePhoto').hide();
        $('#retakePhoto').show();
        
        // Clear file input
        $fileInput.val('');
        
        showToast('Photo captured successfully!', 'success');
    });
    
    // Retake Photo
    $('#retakePhoto').click(function() {
        $('#capturePhoto').show();
        $('#retakePhoto').hide();
        $('#imagePreview').hide();
        capturedImageData = null;
    });
    
    // Stop Camera
    $('#stopCamera').click(function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        $('#cameraSection').hide();
        $('#takePhotoBtn').show();
        $('#capturePhoto').show();
        $('#retakePhoto').hide();
    });
    
    // ===== FORM SUBMISSION =====
    $('#studentForm').submit(function(e) {
        e.preventDefault();
        
        // Validate all steps
        let allValid = true;
        for (let step = 1; step <= totalSteps; step++) {
            if (!validateStep(step)) {
                allValid = false;
                // Go to first invalid step
                currentStep = step;
                showStep(currentStep);
                break;
            }
        }
        
        if (!allValid) {
            return false;
        }
        
        const $submitBtn = $('#submitBtn');
        
        // Show loading state using new loading system
        loadingStates.showButtonLoading($submitBtn[0], {
            text: 'Registering Student...'
        });
        
        // Handle captured photo submission
        const imageFile = $('#image')[0].files[0];
        if (capturedImageData && !imageFile) {
            // Convert data URL to blob and submit via AJAX
            const formData = new FormData(this);
            
            const dataURLtoBlob = function(dataURL) {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            };
            
            const blob = dataURLtoBlob(capturedImageData);
            // Remove any existing image file from form data
            formData.delete('image');
            // Add the captured photo blob
            formData.append('image', blob, 'captured_photo.jpg');
            
            $.ajax({
                url: $(this).attr('action') || window.location.pathname,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    showToast('Student registered successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/students';
                    }, 1500);
                },
                error: function(xhr) {
                    let errorMsg = 'Error submitting form. Please try again.';
                    if (xhr.responseText) {
                        try {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = xhr.responseText;
                            const alertElement = tempDiv.querySelector('.alert-danger');
                            if (alertElement) {
                                errorMsg = alertElement.textContent.trim();
                            }
                        } catch (e) {
                            console.error('Error parsing response:', e);
                        }
                    }
                    showToast(errorMsg, 'error');
                },
                complete: function() {
                    loadingStates.hideButtonLoading($submitBtn[0]);
                }
            });
        } else {
            // Regular form submission with file upload
            showToast('Submitting registration...', 'info');
            this.submit();
        }
    });
    
    // ===== KEYBOARD NAVIGATION =====
    $(document).keydown(function(e) {
        if (e.ctrlKey || e.metaKey) return; // Don't interfere with browser shortcuts
        
        switch(e.which) {
            case 37: // Left arrow
                if (currentStep > 1) {
                    e.preventDefault();
                    $('#prevBtn').click();
                }
                break;
            case 39: // Right arrow
                if (currentStep < totalSteps) {
                    e.preventDefault();
                    $('#nextBtn').click();
                }
                break;
            case 13: // Enter
                if (e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    if (currentStep < totalSteps) {
                        $('#nextBtn').click();
                    } else {
                        $('#submitBtn').click();
                    }
                }
                break;
        }
    });
    
    // ===== CLEANUP AND INITIALIZATION =====
    // Initialize wizard
    showStep(1);
    
    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
    
    // Auto-save form data to localStorage (optional enhancement)
    function saveFormData() {
        const formData = {
            student_id: $('#student_id').val(),
            name: $('#name').val(),
            roll_number: $('#roll_number').val(),
            email: $('#email').val(),
            phone: $('#phone').val(),
            department: $('#department').val(),
            course: $('#course').val(),
            year: $('#year').val(),
            section: $('#section').val(),
            semester: $('#semester').val(),
            batch: $('#batch').val()
        };
        localStorage.setItem('studentRegistrationForm', JSON.stringify(formData));
    }
    
    function loadFormData() {
        const savedData = localStorage.getItem('studentRegistrationForm');
        if (savedData) {
            try {
                const formData = JSON.parse(savedData);
                Object.keys(formData).forEach(key => {
                    if (formData[key]) {
                        $(`#${key}`).val(formData[key]);
                    }
                });
            } catch (e) {
                console.error('Error loading saved form data:', e);
            }
        }
    }
    
    // Load saved data on page load
    loadFormData();
    
    // Save data on input change
    $('.form-control-glass').on('input change', function() {
        saveFormData();
    });
    
    // Clear saved data on successful submission
    $('#studentForm').on('submit', function() {
        localStorage.removeItem('studentRegistrationForm');
    });
});

// ===== UTILITY FUNCTIONS =====
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
</script>
{% endblock %}
