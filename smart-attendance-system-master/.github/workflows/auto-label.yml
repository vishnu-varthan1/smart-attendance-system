name: Auto Label Issues & PRs

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  label-issues:
    name: Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    permissions:
      issues: write
    steps:
      - name: Label based on title/body
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const content = title + ' ' + body;
            
            const labels = [];
            
            // Bug detection
            if (content.includes('bug') || content.includes('error') || content.includes('fix') || content.includes('broken') || content.includes('crash')) {
              labels.push('bug');
            }
            
            // Feature request
            if (content.includes('feature') || content.includes('enhancement') || content.includes('add') || content.includes('new')) {
              labels.push('enhancement');
            }
            
            // Documentation
            if (content.includes('doc') || content.includes('readme') || content.includes('documentation')) {
              labels.push('documentation');
            }
            
            // UI related
            if (content.includes('ui') || content.includes('frontend') || content.includes('css') || content.includes('template') || content.includes('design')) {
              labels.push('ui');
            }
            
            // Face recognition
            if (content.includes('face') || content.includes('recognition') || content.includes('detection') || content.includes('camera')) {
              labels.push('face-recognition');
            }
            
            // Database
            if (content.includes('database') || content.includes('db') || content.includes('sql') || content.includes('model')) {
              labels.push('database');
            }
            
            // API
            if (content.includes('api') || content.includes('endpoint') || content.includes('route')) {
              labels.push('api');
            }
            
            // Priority detection
            if (content.includes('urgent') || content.includes('critical') || content.includes('asap')) {
              labels.push('priority: high');
            }
            
            // Security
            if (content.includes('security') || content.includes('vulnerability') || content.includes('auth')) {
              labels.push('security');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

  label-pr:
    name: Label Pull Requests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Label PR by files changed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const labels = new Set();
            
            for (const file of files) {
              const filename = file.filename.toLowerCase();
              
              if (filename.includes('test')) labels.add('tests');
              if (filename.endsWith('.py')) labels.add('python');
              if (filename.endsWith('.html')) labels.add('frontend');
              if (filename.endsWith('.css') || filename.endsWith('.js')) labels.add('frontend');
              if (filename.includes('template')) labels.add('ui');
              if (filename.includes('face_recognition')) labels.add('face-recognition');
              if (filename.includes('database') || filename.includes('model')) labels.add('database');
              if (filename.includes('.github')) labels.add('ci/cd');
              if (filename.includes('readme') || filename.endsWith('.md')) labels.add('documentation');
              if (filename.includes('config')) labels.add('configuration');
            }
            
            // Size labels
            const additions = context.payload.pull_request.additions;
            const deletions = context.payload.pull_request.deletions;
            const totalChanges = additions + deletions;
            
            if (totalChanges < 10) labels.add('size: XS');
            else if (totalChanges < 50) labels.add('size: S');
            else if (totalChanges < 200) labels.add('size: M');
            else if (totalChanges < 500) labels.add('size: L');
            else labels.add('size: XL');
            
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: Array.from(labels)
              });
            }
