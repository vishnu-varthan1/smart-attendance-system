name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    name: Code Review Checks
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install review tools
        run: |
          pip install flake8 pylint radon
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.py
      
      - name: Run pylint on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## Pylint Report" > review-report.md
          echo "" >> review-report.md
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "### $file" >> review-report.md
            pylint "$file" --output-format=text --score=yes 2>/dev/null >> review-report.md || true
            echo "" >> review-report.md
          done
        continue-on-error: true
      
      - name: Check code complexity
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## Complexity Report" >> review-report.md
          echo "" >> review-report.md
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "### $file" >> review-report.md
            radon cc "$file" -a -s 2>/dev/null >> review-report.md || true
            echo "" >> review-report.md
          done
        continue-on-error: true
      
      - name: Post review comment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let report = '';
            try {
              report = fs.readFileSync('review-report.md', 'utf8');
            } catch (e) {
              report = 'No Python files changed or review completed successfully.';
            }
            
            // Truncate if too long
            if (report.length > 60000) {
              report = report.substring(0, 60000) + '\n\n... (truncated)';
            }
            
            const body = `## ðŸ¤– Automated Code Review\n\n${report}\n\n---\n*This is an automated review. Please address any issues before merging.*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
            
            const botComment = comments.find(c => c.body.includes('ðŸ¤– Automated Code Review'));
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

  pr-checklist:
    name: PR Checklist
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add PR checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Only add checklist on new PRs
            if (context.payload.action !== 'opened') return;
            
            const checklist = `## PR Checklist
            
            Please ensure the following before requesting review:
            
            - [ ] Code follows project style guidelines
            - [ ] Self-review completed
            - [ ] Comments added for complex logic
            - [ ] Tests added/updated (if applicable)
            - [ ] Documentation updated (if applicable)
            - [ ] No sensitive data exposed
            - [ ] Database migrations included (if schema changed)
            
            ---
            **PR Stats:**
            - Files changed: ${pr.changed_files}
            - Additions: +${pr.additions}
            - Deletions: -${pr.deletions}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: checklist
            });
