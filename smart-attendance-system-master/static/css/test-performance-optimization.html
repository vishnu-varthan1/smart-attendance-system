<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Optimization Test Suite</title>
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="minified-bundle.css">
    <link rel="stylesheet" href="performance-optimizations.css">
    <link rel="stylesheet" href="cross-browser-fixes.css">
    
    <!-- Bootstrap for base styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 2rem;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        
        .performance-stats {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .test-result {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 4px;
        }
        
        .test-pass {
            background: #d4edda;
            color: #155724;
        }
        
        .test-fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .animation-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .animation-test-card {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">Performance Optimization Test Suite</h1>
        
        <!-- Performance Metrics Dashboard -->
        <div class="test-section">
            <h2><i class="fas fa-tachometer-alt"></i> Performance Metrics</h2>
            <div class="performance-stats" id="performanceStats">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Page Load Time:</strong>
                        <div id="pageLoadTime">Measuring...</div>
                    </div>
                    <div class="col-md-3">
                        <strong>FPS:</strong>
                        <div id="currentFPS">Measuring...</div>
                    </div>
                    <div class="col-md-3">
                        <strong>LCP:</strong>
                        <div id="lcpTime">Measuring...</div>
                    </div>
                    <div class="col-md-3">
                        <strong>CLS:</strong>
                        <div id="clsScore">Measuring...</div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary" onclick="runPerformanceTest()">
                        <i class="fas fa-play"></i> Run Performance Test
                    </button>
                    <button class="btn btn-warning" onclick="triggerOptimization()">
                        <i class="fas fa-rocket"></i> Optimize Performance
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-info" onclick="exportMetrics()">
                        <i class="fas fa-download"></i> Export Metrics
                    </button>
                    <button class="btn btn-secondary" onclick="clearMetrics()">
                        <i class="fas fa-trash"></i> Clear Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Browser Compatibility Tests -->
        <div class="test-section">
            <h2><i class="fas fa-globe"></i> Browser Compatibility</h2>
            <div id="browserTests">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Detected Browser</h4>
                        <div id="browserInfo" class="alert alert-info"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>Feature Support</h4>
                        <div id="featureSupport"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Animation Performance Tests -->
        <div class="test-section">
            <h2><i class="fas fa-magic"></i> Animation Performance Tests</h2>
            <p>Click on cards to test animation performance. Monitor FPS in the metrics above.</p>
            
            <div class="animation-test-grid">
                <div class="animation-test-card glass gpu-accelerated fade-in-optimized" onclick="testAnimation(this)">
                    <span>GPU Accelerated Glass</span>
                </div>
                <div class="animation-test-card card-optimized" onclick="testAnimation(this)">
                    <span>Optimized Card Hover</span>
                </div>
                <div class="animation-test-card btn-optimized" onclick="testAnimation(this)">
                    <span>Optimized Button</span>
                </div>
                <div class="animation-test-card scale-hover-optimized" onclick="testAnimation(this)">
                    <span>Scale Hover Effect</span>
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-success" onclick="runAnimationStressTest()">
                    <i class="fas fa-bolt"></i> Run Animation Stress Test
                </button>
                <button class="btn btn-danger" onclick="stopStressTest()">
                    <i class="fas fa-stop"></i> Stop Stress Test
                </button>
            </div>
        </div>
        
        <!-- Resource Loading Tests -->
        <div class="test-section">
            <h2><i class="fas fa-download"></i> Resource Loading Performance</h2>
            <div id="resourceTests">
                <div class="row">
                    <div class="col-md-6">
                        <h4>CSS Resources</h4>
                        <div id="cssResources"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>JavaScript Resources</h4>
                        <div id="jsResources"></div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary mt-3" onclick="analyzeResources()">
                <i class="fas fa-search"></i> Analyze Resource Performance
            </button>
        </div>
        
        <!-- Cross-Browser Feature Tests -->
        <div class="test-section">
            <h2><i class="fas fa-check-circle"></i> Feature Compatibility Tests</h2>
            <div id="featureTests" class="row"></div>
        </div>
        
        <!-- Performance Issues Log -->
        <div class="test-section">
            <h2><i class="fas fa-exclamation-triangle"></i> Performance Issues</h2>
            <div id="performanceIssues"></div>
            <button class="btn btn-warning mt-2" onclick="refreshIssues()">
                <i class="fas fa-refresh"></i> Refresh Issues
            </button>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="browser-compatibility.js"></script>
    <script src="performance-monitor.js"></script>
    <script src="asset-loader.js"></script>
    
    <script>
        let stressTestInterval;
        let animationCount = 0;
        
        // Initialize tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTests();
            updateMetricsDisplay();
            setInterval(updateMetricsDisplay, 2000);
        });
        
        function initializeTests() {
            displayBrowserInfo();
            displayFeatureSupport();
            runFeatureTests();
            refreshIssues();
        }
        
        function displayBrowserInfo() {
            const browser = window.getBrowser();
            const browserInfo = document.getElementById('browserInfo');
            browserInfo.innerHTML = `
                <strong>Browser:</strong> ${browser}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Platform:</strong> ${navigator.platform}
            `;
        }
        
        function displayFeatureSupport() {
            const features = window.browserCompatibility.getFeatures();
            const featureSupport = document.getElementById('featureSupport');
            
            let html = '';
            Object.entries(features).forEach(([feature, supported]) => {
                const className = supported ? 'test-pass' : 'test-fail';
                html += `<div class="test-result ${className}">${feature}: ${supported ? 'Supported' : 'Not Supported'}</div>`;
            });
            
            featureSupport.innerHTML = html;
        }
        
        function runFeatureTests() {
            const tests = [
                {
                    name: 'Backdrop Filter',
                    test: () => CSS.supports('backdrop-filter', 'blur(20px)'),
                    fallback: 'Using background color fallback'
                },
                {
                    name: 'CSS Grid',
                    test: () => CSS.supports('display', 'grid'),
                    fallback: 'Using flexbox fallback'
                },
                {
                    name: 'CSS Custom Properties',
                    test: () => CSS.supports('--custom', 'property'),
                    fallback: 'Using static values'
                },
                {
                    name: 'Web Animations API',
                    test: () => 'animate' in document.createElement('div'),
                    fallback: 'Using CSS animations'
                },
                {
                    name: 'Intersection Observer',
                    test: () => 'IntersectionObserver' in window,
                    fallback: 'Using scroll events'
                },
                {
                    name: 'Performance Observer',
                    test: () => 'PerformanceObserver' in window,
                    fallback: 'Limited performance monitoring'
                }
            ];
            
            const featureTests = document.getElementById('featureTests');
            let html = '';
            
            tests.forEach(test => {
                const supported = test.test();
                const className = supported ? 'test-pass' : 'test-warning';
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="test-result ${className}">
                            <strong>${test.name}:</strong> ${supported ? 'Supported' : 'Not Supported'}
                            ${!supported ? `<br><small>${test.fallback}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            featureTests.innerHTML = html;
        }
        
        function updateMetricsDisplay() {
            const metrics = window.getPerformanceMetrics();
            
            // Update page load time
            if (metrics.pageLoad.total) {
                document.getElementById('pageLoadTime').textContent = 
                    `${metrics.pageLoad.total.toFixed(2)}ms`;
            }
            
            // Update FPS
            if (metrics.animations.fps) {
                const fps = metrics.animations.fps;
                const fpsElement = document.getElementById('currentFPS');
                fpsElement.textContent = `${fps.toFixed(1)} fps`;
                fpsElement.className = fps >= 55 ? 'text-success' : fps >= 30 ? 'text-warning' : 'text-danger';
            }
            
            // Update LCP
            if (metrics.webVitals.lcp) {
                const lcp = metrics.webVitals.lcp;
                const lcpElement = document.getElementById('lcpTime');
                lcpElement.textContent = `${lcp.toFixed(2)}ms`;
                lcpElement.className = lcp <= 2500 ? 'text-success' : lcp <= 4000 ? 'text-warning' : 'text-danger';
            }
            
            // Update CLS
            if (metrics.webVitals.cls !== undefined) {
                const cls = metrics.webVitals.cls;
                const clsElement = document.getElementById('clsScore');
                clsElement.textContent = cls.toFixed(3);
                clsElement.className = cls <= 0.1 ? 'text-success' : cls <= 0.25 ? 'text-warning' : 'text-danger';
            }
        }
        
        function testAnimation(element) {
            animationCount++;
            element.style.transform = 'scale(1.1) rotate(5deg)';
            element.style.transition = 'transform 0.3s ease';
            
            setTimeout(() => {
                element.style.transform = '';
            }, 300);
        }
        
        function runAnimationStressTest() {
            const cards = document.querySelectorAll('.animation-test-card');
            let index = 0;
            
            stressTestInterval = setInterval(() => {
                testAnimation(cards[index % cards.length]);
                index++;
                
                if (index > 100) { // Stop after 100 animations
                    stopStressTest();
                }
            }, 100);
        }
        
        function stopStressTest() {
            if (stressTestInterval) {
                clearInterval(stressTestInterval);
                stressTestInterval = null;
            }
        }
        
        function runPerformanceTest() {
            // Simulate various performance scenarios
            const testButton = event.target;
            testButton.disabled = true;
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            
            // Test 1: Heavy DOM manipulation
            setTimeout(() => {
                const testContainer = document.createElement('div');
                for (let i = 0; i < 1000; i++) {
                    const div = document.createElement('div');
                    div.className = 'fade-in-optimized';
                    div.textContent = `Test element ${i}`;
                    testContainer.appendChild(div);
                }
                document.body.appendChild(testContainer);
                
                // Clean up after test
                setTimeout(() => {
                    document.body.removeChild(testContainer);
                }, 2000);
            }, 500);
            
            // Test 2: Animation performance
            setTimeout(() => {
                runAnimationStressTest();
            }, 1000);
            
            // Re-enable button
            setTimeout(() => {
                testButton.disabled = false;
                testButton.innerHTML = '<i class="fas fa-play"></i> Run Performance Test';
            }, 3000);
        }
        
        function triggerOptimization() {
            window.optimizePerformance();
            alert('Performance optimization triggered. Check console for details.');
        }
        
        function analyzeResources() {
            const resources = performance.getEntriesByType('resource');
            const cssResources = document.getElementById('cssResources');
            const jsResources = document.getElementById('jsResources');
            
            const css = resources.filter(r => r.name.includes('.css'));
            const js = resources.filter(r => r.name.includes('.js'));
            
            cssResources.innerHTML = css.map(r => `
                <div class="test-result ${r.duration > 500 ? 'test-warning' : 'test-pass'}">
                    ${r.name.split('/').pop()}: ${r.duration.toFixed(2)}ms
                    (${(r.transferSize / 1024).toFixed(2)}KB)
                </div>
            `).join('');
            
            jsResources.innerHTML = js.map(r => `
                <div class="test-result ${r.duration > 500 ? 'test-warning' : 'test-pass'}">
                    ${r.name.split('/').pop()}: ${r.duration.toFixed(2)}ms
                    (${(r.transferSize / 1024).toFixed(2)}KB)
                </div>
            `).join('');
        }
        
        function refreshIssues() {
            const issues = window.getPerformanceIssues();
            const issuesContainer = document.getElementById('performanceIssues');
            
            if (issues.length === 0) {
                issuesContainer.innerHTML = '<div class="test-pass">No performance issues detected!</div>';
                return;
            }
            
            issuesContainer.innerHTML = issues.slice(-10).map(issue => `
                <div class="test-result test-warning">
                    <strong>[${issue.category}]</strong> ${issue.message}
                    <br><small>${new Date(issue.timestamp).toLocaleTimeString()}</small>
                </div>
            `).join('');
        }
        
        function exportMetrics() {
            const metrics = window.getPerformanceMetrics();
            const issues = window.getPerformanceIssues();
            const reports = window.performanceMonitor.getReports();
            
            const exportData = {
                timestamp: Date.now(),
                url: window.location.href,
                browser: window.getBrowser(),
                features: window.browserCompatibility.getFeatures(),
                metrics,
                issues,
                reports
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance-report-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function clearMetrics() {
            window.performanceMonitor.clearData();
            refreshIssues();
            alert('Performance data cleared!');
        }
    </script>
</body>
</html>